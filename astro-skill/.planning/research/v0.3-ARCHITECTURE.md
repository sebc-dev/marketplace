# Architecture: XML Semantic Restructuring of Reference Files (v0.3)

**Domain:** Restructuring 11 reference files with XML semantic containers while preserving grep-based navigation
**Researched:** 2026-02-04
**Overall confidence:** HIGH for grep compatibility and container strategy, MEDIUM for exact token overhead (estimated from character counts, not measured with tokenizer)

---

## Executive Summary

The 11 reference files (2,915 lines, ~125KB) currently use flat Markdown with `## Header` sections. The v0.3 restructuring wraps each functional section in XML semantic containers (`<snake_case_tag>`) while preserving all `## Header` lines exactly as-is inside those containers. This is a structure-only change with zero content modification.

The critical architectural insight: **grep compatibility is guaranteed by design.** `grep -n "## Quick Reference"` is a line-based text search. XML tags occupy their own lines (`<tag>` on line N, content on lines N+1..M, `</tag>` on line M+1). The `## Header` text remains on its own line, unchanged. All 102 grep patterns in SKILL.md continue to work without modification.

The restructuring follows the pattern documented in the project's own design document (`docs/cc-skills/XML Markdown pour references Skill Caude Code.md`): XML for semantic structure, Markdown for internal content. The decision tree from that document confirms all 11 files qualify (3+ sections, all exceed 500 tokens significantly).

---

## Grep Pattern Compatibility Analysis

### Why All 102 Patterns Survive Unchanged

SKILL.md contains 102 grep patterns of the form:

```
grep -n "## Section Name" references/filename.md
```

These patterns search for **exact text on a line**. The XML restructuring places opening/closing tags on **separate lines** from content:

**Before (current):**
```markdown
## Quick Reference
1. Rule one
2. Rule two

## Anti-patterns
| Don't | Do | Impact |
```

**After (restructured):**
```markdown
<quick_reference>
## Quick Reference
1. Rule one
2. Rule two
</quick_reference>

<anti_patterns>
## Anti-patterns
| Don't | Do | Impact |
</anti_patterns>
```

The grep pattern `grep -n "## Quick Reference"` matches the **line content**, not its surrounding context. The line `## Quick Reference` is identical in both versions. The only change is the **line number** returned by `grep -n` (shifted by the number of XML opening tags above it).

**Line number shift impact:** SKILL.md grep patterns are used to **navigate to a section**, not to read a specific line. Claude reads from the matched line downward. A shifted line number still navigates to the correct section. No SKILL.md changes required.

**Confidence:** HIGH -- this is how grep fundamentally works. There is zero risk of pattern breakage.

### SKILL.md Changes Required

**None.** The 102 grep patterns, the Reference Navigation section, and the Quick Troubleshooting Index all remain valid. The only observable change is that `grep -n` returns different line numbers (shifted by +1 to +N depending on how many XML tags precede the section). This does not affect functionality.

---

## Container Strategy

### Tag Naming Convention

All files follow the same naming rules:

- **snake_case** for all tag names (per project design doc convention)
- Tag names describe **content function**, not format (e.g., `<decision_matrix>` not `<table_1>`)
- No redundancy between tag name and the `## Header` inside it
- Maximum nesting depth: **1 level** (flat siblings, no nested XML)

### Universal Container Pattern

Every reference file has three recurring section types that appear in all 11 files:

| Section | Container Tag | Present In |
|---------|--------------|------------|
| Quick Reference (numbered rules) | `<quick_reference>` | 11/11 files |
| Anti-patterns table | `<anti_patterns>` | 11/11 files |
| Troubleshooting table | `<troubleshooting>` | 11/11 files |

These three containers are **structurally identical** across all files. This uniformity enables a batch approach for Phase 1.

### Content-Specific Containers

The middle sections (between Quick Reference and Anti-patterns) vary per file. These group into functional categories:

| Content Type | Container Tag Pattern | Examples |
|-------------|----------------------|----------|
| Decision matrix / selection table | `<decision_matrix>` or `<[topic]_selection>` | `<rendering_mode_selection>`, `<loader_selection>` |
| Code pattern with explanation | `<[topic]_pattern>` | `<server_island_pattern>`, `<middleware_pattern>` |
| Config template | `<config_templates>` or `<[tool]_config>` | `<vitest_config>`, `<wrangler_config>` |
| Feature comparison table | `<feature_compatibility>` or `<[topic]_comparison>` | `<feature_compatibility>`, `<css_approach_selection>` |
| Reference table (limits, priority, etc.) | `<[topic]_reference>` | `<workers_limits>`, `<route_priority>` |

### Rules vs Examples Separation

The design document recommends separating `<rules>` from `<examples>` when they are mixed. Analyzing the current files:

**Files that already separate rules from examples:** All 11 files. The current structure uses `## Quick Reference` for rules (numbered list) and separate `## [Topic] Pattern` sections for code examples. The separation already exists at the Markdown level.

**Recommendation:** Do NOT add a secondary rules/examples split inside individual containers. The current file organization already achieves this separation. Adding inner `<rules>` / `<examples>` tags would create 2-level nesting and add overhead without benefit.

### Attribute Usage

XML attributes are useful for differentiating repeated elements of the same type. In the current files:

- **project-structure.md** has multiple `### astro.config.mjs` subsections (SSG, SSR, Static+SSR) -- these are already differentiated by `### Header` text, so attributes are unnecessary
- **security-advanced.md** has distinct pattern sections (security headers, auth, actions, CSP) -- already differentiated by `## Header` names

**Recommendation:** Do NOT use XML attributes. The `## Header` names inside containers already provide sufficient differentiation. Attributes would add token overhead without improving attention targeting.

---

## Per-File Container Maps

### 1. rendering-modes.md (161 lines, 7 sections)

```
<quick_reference>        ## Quick Reference
<output_modes>           ## Output Modes
<decision_matrix>        ## Decision Matrix
<server_islands>         ## Server Islands
<feature_compatibility>  ## Feature Compatibility
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 7 open + 7 close = 14 lines
**Estimated overhead:** ~210 bytes (~2.3% of 9,230 bytes)

### 2. cloudflare-platform.md (242 lines, 8 sections)

```
<quick_reference>        ## Quick Reference
<bindings_access>        ## Bindings Access
<workers_limits>         ## Workers Limits
<nodejs_compatibility>   ## Node.js Compatibility
<environment_variables>  ## Environment Variables
<config_templates>       ## Config Templates (includes ### wrangler.jsonc, ### .dev.vars)
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 8 open + 8 close = 16 lines
**Estimated overhead:** ~280 bytes (~3.1% of 9,002 bytes)

### 3. project-structure.md (250 lines, 6 sections)

```
<quick_reference>        ## Quick Reference
<file_organization>      ## File Organization
<naming_conventions>     ## Naming Conventions
<config_templates>       ## Config Templates (includes all ### subsections)
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 6 open + 6 close = 12 lines
**Estimated overhead:** ~200 bytes (~2.2% of 9,239 bytes)

### 4. seo-i18n.md (251 lines, 11 sections)

```
<quick_reference>        ## Quick Reference
<seo_component>          ## SEO Component Pattern
<sitemap_config>         ## Sitemap Config
<json_ld>                ## JSON-LD Structured Data
<rss_endpoint>           ## RSS Endpoint
<i18n_config>            ## i18n Config
<hreflang>               ## Hreflang Component
<translation_matrix>     ## Translation Decision Matrix
<language_detection>     ## Language Detection Middleware
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 11 open + 11 close = 22 lines
**Estimated overhead:** ~380 bytes (~3.5% of 11,005 bytes)

### 5. build-deploy.md (262 lines, 13 sections)

```
<quick_reference>        ## Quick Reference
<output_mode_matrix>     ## Output Mode Decision Matrix
<deployment_target>      ## Deployment Target Decision Matrix
<dev_preview_workflow>   ## Dev/Preview Workflow Matrix
<package_scripts>        ## Package.json Scripts
<ci_cd>                  ## GitHub Actions CI/CD
<assetsignore>           ## .assetsignore for Workers Static Assets
<adapter_options>        ## Adapter Options
<cli_flags>              ## CLI Flags Reference
<debugging_workflow>     ## Debugging Workflow
<vscode_config>          ## VS Code Configuration
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 13 open + 13 close = 26 lines
**Estimated overhead:** ~480 bytes (~3.6% of 13,408 bytes)

### 6. components-islands.md (265 lines, 9 sections)

```
<quick_reference>        ## Quick Reference
<hydration_matrix>       ## Hydration Directive Decision Matrix
<island_comparison>      ## Island vs Static vs Server Island
<nanostores_pattern>     ## Nanostores Pattern
<server_island_pattern>  ## Server Island Pattern
<slots_rendering>        ## Slots and Conditional Rendering
<component_typing>       ## Component Typing Patterns
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 9 open + 9 close = 18 lines
**Estimated overhead:** ~340 bytes (~2.8% of 12,044 bytes)

### 7. routing-navigation.md (273 lines, 12 sections)

```
<quick_reference>        ## Quick Reference
<routing_strategy>       ## Routing Strategy Decision Matrix
<redirect_methods>       ## Redirect Method Selection
<route_priority>         ## Route Priority Reference
<dynamic_routes>         ## Dynamic Routes with getStaticPaths
<cloudflare_routes>      ## Cloudflare Route Configuration
<middleware_pattern>     ## Middleware Pattern
<catch_all_guard>        ## Catch-all Route Guard Pattern
<api_endpoint>           ## API Endpoint Pattern
<client_router>          ## ClientRouter
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 12 open + 12 close = 24 lines
**Estimated overhead:** ~420 bytes (~3.5% of 11,922 bytes)

### 8. typescript-testing.md (282 lines, 11 sections)

```
<quick_reference>        ## Quick Reference
<typescript_config>      ## TypeScript Config Decision Matrix
<env_dts>                ## env.d.ts Full Pattern
<test_type_matrix>       ## Test Type Decision Matrix
<vitest_config>          ## Vitest Config
<container_api_test>     ## Container API Test
<bindings_test>          ## Cloudflare Bindings Test
<playwright_config>      ## Playwright Config
<package_scripts>        ## Package Scripts
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 11 open + 11 close = 22 lines
**Estimated overhead:** ~380 bytes (~3.0% of 12,725 bytes)

### 9. data-content.md (290 lines, 13 sections)

```
<quick_reference>        ## Quick Reference
<loader_selection>       ## Loader Selection Matrix
<actions_vs_api>         ## Actions vs API Routes
<content_layer_config>   ## Content Layer Config
<csv_loader>             ## CSV File Loader
<async_loader>           ## Inline Async Loader
<actions_signature>      ## Astro Actions Basic Signature
<mdx_markdoc>            ## MDX / Markdoc Decision
<rendering_content>      ## Rendering Content
<querying_collections>   ## Querying Collections
<ssr_data_fetching>      ## SSR Data Fetching on Cloudflare
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 13 open + 13 close = 26 lines
**Estimated overhead:** ~440 bytes (~3.8% of 11,559 bytes)

### 10. styling-performance.md (296 lines, 12 sections)

```
<quick_reference>        ## Quick Reference
<image_service>          ## Image Service Selection
<image_patterns>         ## Image Component Patterns
<scoped_styles>          ## Scoped Style Propagation
<css_approach>           ## CSS Approach Selection
<tailwind_v4>            ## Tailwind v4 Setup
<caching_strategy>       ## Caching Strategy
<headers_file>           ## _headers File Pattern
<prefetch_strategy>      ## Prefetch Strategy
<ssr_cache_headers>      ## SSR Cache Headers
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 12 open + 12 close = 24 lines
**Estimated overhead:** ~380 bytes (~3.3% of 11,673 bytes)

### 11. security-advanced.md (343 lines, 15 sections)

```
<quick_reference>        ## Quick Reference
<security_matrix>        ## Security Decision Matrix
<security_headers>       ## Security Headers Middleware
<auth_middleware>         ## Auth Middleware Pattern
<actions_security>       ## Actions Security Pattern
<secrets_management>     ## Secrets Management
<csp_config>             ## CSP Config
<mdx_markdoc_advanced>   ## MDX/Markdoc Advanced Setup
<remark_rehype>          ## Remark/Rehype Plugin Config
<custom_components>      ## Custom Component Mapping
<markdoc_tags>           ## Markdoc Custom Tags
<shiki_dual_theme>       ## Shiki Dual Theme CSS
<custom_remark_plugin>   ## Custom Remark Plugin
<anti_patterns>          ## Anti-patterns
<troubleshooting>        ## Troubleshooting
```

**Tags added:** 15 open + 15 close = 30 lines
**Estimated overhead:** ~560 bytes (~4.2% of 13,272 bytes)

---

## Token Overhead Budget

### Aggregate Numbers

| Metric | Value |
|--------|-------|
| Total XML tags to add | 117 open + 117 close = 234 tag lines |
| Total estimated bytes | ~4,070 bytes added |
| Current total file size | 125,079 bytes |
| Overhead percentage | **~3.3%** |
| Estimated token overhead | ~1,000-1,200 tokens across all 11 files |
| Per-file average overhead | ~90-110 tokens |

### Per-File Budget

| File | Lines | Sections | Tags Added | Bytes Added | Overhead % |
|------|-------|----------|-----------|-------------|------------|
| rendering-modes.md | 161 | 7 | 14 | ~210 | 2.3% |
| cloudflare-platform.md | 242 | 8 | 16 | ~280 | 3.1% |
| project-structure.md | 250 | 6 | 12 | ~200 | 2.2% |
| seo-i18n.md | 251 | 11 | 22 | ~380 | 3.5% |
| build-deploy.md | 262 | 13 | 26 | ~480 | 3.6% |
| components-islands.md | 265 | 9 | 18 | ~340 | 2.8% |
| routing-navigation.md | 273 | 12 | 24 | ~420 | 3.5% |
| typescript-testing.md | 282 | 11 | 22 | ~380 | 3.0% |
| data-content.md | 290 | 13 | 26 | ~440 | 3.8% |
| styling-performance.md | 296 | 12 | 24 | ~380 | 3.3% |
| security-advanced.md | 343 | 15 | 30 | ~560 | 4.2% |

The overhead is well within the 5-10% range documented in the project's design document as acceptable, and toward the lower end. Files with more sections (security-advanced: 15 sections) have slightly higher overhead (4.2%) but still below 5%.

---

## Transformation Rules

### Rule 1: Tag Placement

Opening tag goes on its own line immediately before the `## Header`. Closing tag goes on its own line after the last content line of that section (the line before the next `## Header` or EOF).

```markdown
</previous_section>

<current_section>
## Current Section Header
Content...
</current_section>

<next_section>
## Next Section Header
```

### Rule 2: File Title Excluded

The `# File Title` line (line 1) and any subtitle description (line 2-3) remain **outside** any XML container. They are file-level metadata, not a functional section.

```markdown
# Security and Advanced Patterns

CSP, auth middleware, Actions security...

<quick_reference>
## Quick Reference
1. Rule one
...
</quick_reference>
```

### Rule 3: Subsections Stay Inside Parent Container

`### Sub-heading` sections within a `## Section` remain inside the parent container. Do not create nested XML tags for subsections.

```markdown
<config_templates>
## Config Templates

### astro.config.mjs -- SSG
...code...

### astro.config.mjs -- SSR
...code...

### tsconfig.json
...code...
</config_templates>
```

### Rule 4: MCP Callouts Stay Inside Their Section Container

The v0.2 MCP callouts (`> **Cloudflare MCP:** ...`) remain inside the container of the section they annotate:

```markdown
<bindings_access>
## Bindings Access
...content...

> **Cloudflare MCP:** For complete KV/D1/R2 binding method signatures...
</bindings_access>
```

### Rule 5: Horizontal Rules Removed

The `---` horizontal rules used as section separators (present in security-advanced.md between CSP Config and MDX/Markdoc sections) are no longer needed -- XML containers provide clearer boundaries. Remove them.

### Rule 6: Blank Lines

One blank line after opening tag (before `## Header`). One blank line before closing tag (after last content). This maintains readability.

```markdown
<section_name>

## Section Header
Content...

</section_name>
```

Wait -- this conflicts with the goal of minimal overhead. Revised:

**No extra blank lines added for XML tags.** The existing blank lines between sections are sufficient. The tag sits on its own line, adjacent to existing whitespace.

```markdown
<quick_reference>
## Quick Reference
1. Rule one
2. Rule two
</quick_reference>

<decision_matrix>
## Decision Matrix
| Col 1 | Col 2 |
</decision_matrix>
```

---

## Build Order and Phasing Strategy

### Grouping Rationale

The 11 files should be restructured in **complexity order** (fewest sections first), not by content domain. Reasons:

1. **Simplest files validate the pattern** -- rendering-modes.md (7 sections) is the safest first candidate
2. **Pattern stabilization** -- the first 2-3 files establish the mechanical rhythm; corrections propagate to later files
3. **Risk isolation** -- if the pattern needs adjustment, fewer files need rework
4. **Grep validation is cheap** -- after each file, run the file-specific grep patterns from SKILL.md to confirm

### Recommended Build Order

**Phase 1: Pattern Establishment (3 files, simplest)**

Priority is validating the mechanical transformation on the smallest files.

| Order | File | Sections | Lines | Risk |
|-------|------|----------|-------|------|
| 1 | rendering-modes.md | 7 | 161 | LOW -- smallest, cleanest structure |
| 2 | project-structure.md | 6 | 250 | LOW -- only 6 sections, no MCP callouts |
| 3 | cloudflare-platform.md | 8 | 242 | LOW -- 8 sections, has MCP callouts (tests Rule 4) |

**Validation gate:** After Phase 1, run all grep patterns for these 3 files (17 patterns) to confirm match. This validates the approach before touching 8 more files.

**Phase 2: Medium Complexity (4 files)**

| Order | File | Sections | Lines | Risk |
|-------|------|----------|-------|------|
| 4 | components-islands.md | 9 | 265 | LOW -- pure Astro, no MCP callouts |
| 5 | seo-i18n.md | 11 | 251 | LOW -- 11 sections but all short |
| 6 | typescript-testing.md | 11 | 282 | LOW -- has MCP callouts |
| 7 | build-deploy.md | 13 | 262 | LOW -- most MCP callouts (3), tests Rule 4 at scale |

**Validation gate:** Run all grep patterns for these 4 files (43 patterns) plus re-confirm Phase 1 files.

**Phase 3: High Complexity (4 files, most sections)**

| Order | File | Sections | Lines | Risk |
|-------|------|----------|-------|------|
| 8 | routing-navigation.md | 12 | 273 | LOW -- many sections but well-separated |
| 9 | data-content.md | 13 | 290 | LOW -- 13 sections, consistent pattern |
| 10 | styling-performance.md | 12 | 296 | LOW -- 12 sections, straightforward |
| 11 | security-advanced.md | 15 | 343 | MEDIUM -- most sections (15), has `---` separator to remove, has adjacent `##` headers without blank lines between |

**Validation gate:** Full 102-pattern grep validation across all 11 files. Byte-identical content check (content inside tags unchanged).

### Why This Order, Not By Domain

Alternatives considered:

- **By content domain similarity** (rendering + components, then platform + deploy, etc.): No advantage -- the transformation is mechanical, not content-dependent
- **By risk** (files with MCP callouts first): MCP callouts are low-risk (they stay inside containers), testing them early is not critical
- **By usage frequency**: Unknown which files are accessed most; no data to optimize on
- **By file size**: Similar to complexity order but less precise; line count correlates poorly with section count

Complexity order (section count) is the right axis because the number of sections directly determines the number of XML tags to add and the number of section boundaries to identify correctly.

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Grep patterns break | NONE | N/A | Guaranteed by grep's line-based design; XML tags are on separate lines |
| Content accidentally modified | LOW | HIGH | Diff each file, verify only tag lines added (no content lines changed) |
| Misidentified section boundaries | LOW | MEDIUM | Count sections per file against known counts; verify tag count = 2x section count |
| Token overhead exceeds budget | NONE | N/A | Calculated at 3.3% average, well under 5% threshold |
| Nested subsections incorrectly wrapped | LOW | LOW | Rule 3 is clear: subsections stay inside parent container |
| `---` separator removal breaks something | NONE | N/A | Horizontal rules are visual-only, not parsed by grep or any tool |
| Adjacent `## Header` lines in security-advanced.md | LOW | LOW | Lines 176-178 have `## MDX/Markdoc Advanced Setup` followed by `## Remark/Rehype Plugin Config` -- need a container boundary between them |

### The security-advanced.md Edge Case

Lines 176-178 of security-advanced.md have two `## Headers` very close together:

```markdown
---

## MDX/Markdoc Advanced Setup

## Remark/Rehype Plugin Config
```

`## MDX/Markdoc Advanced Setup` appears to be a section header with no content before `## Remark/Rehype Plugin Config`. This needs special handling:

**Option A:** Treat `## MDX/Markdoc Advanced Setup` as a visual separator and wrap the subsequent related sections (`## Remark/Rehype Plugin Config`, `## Custom Component Mapping`, `## Markdoc Custom Tags`, `## Shiki Dual Theme CSS`, `## Custom Remark Plugin`) under a single `<mdx_markdoc_advanced>` mega-container. But this breaks the 1-container-per-section rule and would make the grep pattern `grep -n "## MDX/Markdoc Advanced Setup"` point to a container that spans 150+ lines.

**Option B (Recommended):** Wrap `## MDX/Markdoc Advanced Setup` in its own zero-content container. It serves as a visual group heading that grep can still find. Each subsection below gets its own container.

```markdown
<mdx_markdoc_advanced>
## MDX/Markdoc Advanced Setup
</mdx_markdoc_advanced>

<remark_rehype>
## Remark/Rehype Plugin Config
...content...
</remark_rehype>
```

This preserves grep compatibility for the `## MDX/Markdoc Advanced Setup` pattern in SKILL.md (line 261) while keeping containers focused.

---

## Architectural Decisions

### Decision 1: Zero SKILL.md Changes

**Context:** SKILL.md has 102 grep patterns and a navigation index built on `## Header` names.
**Decision:** Do not modify SKILL.md at all in v0.3.
**Rationale:** Grep patterns match line content, not line numbers. XML tags do not appear on `## Header` lines. All patterns remain valid. SKILL.md is at 266 body lines (budget: 500) -- no reason to touch it.
**Consequence:** SKILL.md remains the stable anchor while reference files evolve underneath it.
**Confidence:** HIGH

### Decision 2: Flat Siblings Only (No Nesting)

**Context:** The design document allows 2-3 levels of nesting. Some files have `### Subsection` content.
**Decision:** Use only 1 level of XML tags. No nested containers.
**Rationale:**
- Subsections are already differentiated by `### Header` within their parent container
- Nesting adds token overhead and visual complexity without improving attention targeting
- The files are 160-340 lines -- not long enough for nested XML to provide meaningful attention benefit
- Flat structure is easier to validate mechanically (count tags = 2x section count)
**Consequence:** Each file has N containers where N = number of `## Header` sections.
**Confidence:** HIGH

### Decision 3: No XML Attributes

**Context:** XML attributes (`<pattern name="repository" category="data-access">`) can differentiate repeated elements.
**Decision:** Do not use attributes on any container.
**Rationale:**
- No file has repeated containers of the same tag name (each section has a unique name)
- The `## Header` text inside the container provides equivalent differentiation
- Attributes add parsing complexity and token overhead with no benefit
**Consequence:** All containers are bare `<tag_name>` / `</tag_name>`.
**Confidence:** HIGH

### Decision 4: Keep Existing Blank Line Structure

**Context:** Adding XML tags could add or remove blank lines, changing visual spacing.
**Decision:** Preserve the existing blank line between sections. XML opening tag goes after the blank line, immediately before `## Header`. XML closing tag goes before the blank line that precedes the next section.
**Rationale:** Minimizes diff noise. The transformation should show only XML tag additions in the diff, not whitespace changes.
**Confidence:** HIGH

### Decision 5: Handle File Title Outside Containers

**Context:** Line 1 of each file is `# File Title` and lines 2-3 are sometimes a subtitle.
**Decision:** The file title and subtitle remain outside any XML container, as file-level metadata.
**Rationale:** The file title is not a functional section -- it describes the file. No grep pattern targets `# File Title` (all patterns target `## Section`).
**Confidence:** HIGH

---

## Validation Strategy

### Per-File Validation (During Build)

After each file transformation:

1. **Grep match test:** Run all grep patterns from SKILL.md that target this file. Verify each returns a line number.
2. **Section count:** Count `<` and `</` lines. Open tags = Close tags = Number of `## Header` sections.
3. **Content identity:** Strip XML tags, diff against original. Diff should be empty (zero content changes).
4. **Tag naming:** All tags are snake_case, descriptive, unique within file.

### Full Validation (End of Phase 3)

1. **102/102 grep patterns pass** -- run all grep commands from SKILL.md, verify each returns a result
2. **Total file sizes** -- confirm overhead is within budget (~3.3% aggregate)
3. **No regressions from v0.2** -- MCP callouts still present and correctly placed inside containers
4. **XML well-formedness** -- every opening tag has a closing tag at the correct scope

### Validation Script Approach

A simple validation can be done by extracting all grep patterns from SKILL.md and running them:

```bash
# Extract grep patterns from SKILL.md and execute them
grep 'grep -n' SKILL.md | sed 's/.*`\(grep.*\)`/\1/' | while read cmd; do
  result=$(eval "$cmd" 2>/dev/null)
  if [ -z "$result" ]; then
    echo "FAIL: $cmd"
  else
    echo "PASS: $cmd -> $result"
  fi
done
```

---

## Impact on Future Milestones

### If More Reference Files Are Added (v0.4+)

The container pattern is trivially extensible: any new `## Section` gets a `<snake_case_tag>` wrapper. The pattern is documented and mechanical.

### If Content Changes Within Sections

Content changes inside containers do not affect the XML structure. Adding/removing rules in `## Quick Reference` does not require container changes.

### If New Grep Patterns Are Added to SKILL.md

New grep patterns will work automatically -- they search for `## Header` text that exists identically inside containers.

### If Section Headers Are Renamed

Both the SKILL.md grep pattern AND the container tag name would need updating. This is already the case today (renaming a header breaks the grep pattern). The XML container adds one additional change point (the tag name) but this is a low-cost mechanical change.

---

## Sources

### Project-Specific (HIGH confidence)
- All 11 reference files in `.claude/skills/astro-cloudflare/references/` -- analyzed for section structure, header names, line counts
- `.claude/skills/astro-cloudflare/SKILL.md` -- analyzed for all 102 grep patterns
- `docs/cc-skills/XML Markdown pour references Skill Caude Code.md` -- project design document for XML semantic containers
- `.planning/PROJECT.md` -- v0.3 milestone definition and requirements
- `.planning/research/ARCHITECTURE.md` -- v0.2 architecture (MCP integration), current layer structure

### External (MEDIUM confidence)
- [Anthropic: Use XML tags to structure your prompts](https://docs.claude.com/en/docs/build-with-claude/prompt-engineering/use-xml-tags) -- official guidance on XML tag usage
- [Skill authoring best practices](https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices) -- official skill structure recommendations
- [Claude Agent Skills: First Principles Deep Dive](https://leehanchung.github.io/blogs/2025/10/26/claude-skills-deep-dive/) -- progressive disclosure patterns
- [XML Tags vs Other Dividers in Prompt Quality](https://beginswithai.com/xml-tags-vs-other-dividers-in-prompt-quality/) -- attention mechanism behavior with XML

### Confidence Notes
- Grep compatibility: HIGH -- fundamental property of line-based text search
- Token overhead estimates: MEDIUM -- calculated from byte counts with ~4 chars/token heuristic, not measured with actual tokenizer
- Attention benefit claims (10-42% improvement): LOW for exact numbers -- cited from design doc which cites "Microsoft 2024 and community benchmarks"; not independently verified
- Container map correctness: HIGH -- derived from reading every file and listing every `## Header`
