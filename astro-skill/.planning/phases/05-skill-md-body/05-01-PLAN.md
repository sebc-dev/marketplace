---
phase: 05-skill-md-body
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/SKILL.md
autonomous: true

must_haves:
  truths:
    - "SKILL.md body contains numbered critical rules covering all 10 Astro 5.x breaking changes"
    - "SKILL.md body contains 4 decision matrices (rendering mode, hydration, Actions vs API, Server Islands vs alternatives) each with a bold Default line"
    - "SKILL.md body contains MCP integration section with fully qualified tool name and explicit Use/Do-NOT-use boundary"
    - "SKILL.md total body content after this plan is ~150 lines, well under 500"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/SKILL.md"
      provides: "Cross-cutting rules, decision matrices, MCP boundary"
      contains: "## Critical Rules"
  key_links:
    - from: "SKILL.md Critical Rules"
      to: "references/*.md"
      via: "Breaking changes consolidated from multiple reference files"
      pattern: "NOT.*deprecated|removed"
    - from: "SKILL.md Decision Matrices"
      to: "references/rendering-modes.md, references/components-islands.md, references/data-content.md"
      via: "Compact synthesis of detailed matrices in reference files"
      pattern: "\\*\\*Default:\\*\\*"
    - from: "SKILL.md MCP Integration"
      to: "mcp__astro_doc__search_astro_docs"
      via: "Fully qualified MCP tool name with boundary"
      pattern: "mcp__astro_doc__search_astro_docs"
---

<objective>
Write the first half of the SKILL.md body: Critical Rules (Astro 5.x breaking changes), Decision Matrices (4 compact tables), and MCP Integration section.

Purpose: These sections encode cross-cutting knowledge that spans multiple reference files. They are the first thing Claude reads after skill activation and prevent the most common code generation errors.
Output: SKILL.md body with ~150 lines of cross-cutting content appended after the existing frontmatter (line 19).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-skill-md-body/05-RESEARCH.md

@.claude/skills/astro-cloudflare/SKILL.md
@.claude/skills/astro-cloudflare/references/rendering-modes.md
@.claude/skills/astro-cloudflare/references/components-islands.md
@.claude/skills/astro-cloudflare/references/data-content.md
@.claude/skills/astro-cloudflare/references/routing-navigation.md
@.claude/skills/astro-cloudflare/references/cloudflare-platform.md
@.claude/skills/astro-cloudflare/references/security-advanced.md
@.claude/skills/astro-cloudflare/references/project-structure.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Critical Rules and Decision Matrices</name>
  <files>.claude/skills/astro-cloudflare/SKILL.md</files>
  <action>
Append the following sections after line 19 (after the closing `---` of the YAML frontmatter) of SKILL.md. Leave a blank line after the frontmatter closing `---`.

**Section 1: Critical Rules (~40 lines)**

Write `## Critical Rules (Astro 5.x on Cloudflare)` with 10 numbered imperative rules. These are the most dangerous breaking changes that span multiple reference files. Each rule follows the pattern: `N. DO THIS -- NOT THAT (reason)`.

The 10 rules to include (verified from research inventory):
1. `src/content.config.ts` -- NOT `src/content/config.ts` (path changed in v5)
2. `entry.id` -- NOT `entry.slug` (removed in v5)
3. `import { render } from 'astro:content'` then `render(entry)` -- NOT `entry.render()` (removed in v5)
4. `loader: glob({ ... })` -- NOT `type: 'content'` (deprecated in v5)
5. `<ClientRouter />` from `astro:transitions` -- NOT `<ViewTransitions />` (deprecated v5, removed v6)
6. `Astro.locals.runtime.env.VAR` -- NOT `process.env.VAR` (undefined on Workers runtime)
7. `imageService: { entrypoint: 'astro/assets/services/compile' }` in astro config -- NOT Sharp (incompatible with Workers)
8. `output: 'static'` or `output: 'server'` -- NOT `output: 'hybrid'` (removed in v5, use per-page prerender instead)
9. `decodeURIComponent(Astro.params.slug)` -- NOT raw `Astro.params.slug` (auto-decode removed in v5)
10. `import { z } from 'astro/zod'` -- NOT `import { z } from 'zod'` (use Astro's re-export for Content Layer compatibility)

**Section 2: Decision Matrices (~80 lines)**

Write `## Decision Matrices` with 4 subsections, each a compact horizontal table with a bold `**Default:**` line after it plus a reference link.

### Rendering Mode
Columns: Scenario | Mode | Config
Rows: Pure static | <30% dynamic pages | >70% dynamic pages | Static + personalized sections
Default: `output: 'static'` with `@astrojs/cloudflare` adapter. Reference: rendering-modes.md

### Hydration Directive
Columns: Scenario | Directive | Why
Rows: Below-fold interactive | Above-fold critical | Above-fold non-critical | Mobile-only | Browser APIs required
Default: `client:visible` for most components. Reference: components-islands.md

### Actions vs API Routes
Columns: Use Case | Choice | Why
Rows: Form validation/mutation | REST endpoint (external consumers) | Webhook receiver | Real-time/SSE
Default: Astro Actions for form submissions. Reference: data-content.md

### Server Islands vs Alternatives
Columns: Need | Solution | Why
Rows: Personalized content in static page | Interactive widget | Real-time push data | Auth-gated section
Default: Server Island (`server:defer`) for dynamic-in-static without client JS. Reference: components-islands.md

**Section 3: MCP Integration (~25 lines)**

Write `## MCP Integration` with the fully qualified tool name `mcp__astro_doc__search_astro_docs` and two explicit lists:

"Use MCP when you need:" (4-5 bullet points -- API signatures, config option lists, migration guides beyond Critical Rules, integration setup, version-specific changelogs)

"Use THIS SKILL when you need:" (4-5 bullet points -- architecture decisions, anti-patterns, Cloudflare-specific patterns, grep navigation to reference sections, breaking change prevention)

**Important constraints:**
- Do NOT add any grep hints or reference navigation yet (that is Plan 02)
- Do NOT add a troubleshooting index yet (that is Plan 02)
- Keep total appended content to ~140-160 lines
- No code blocks longer than 5 lines (this is a routing document, not a reference)
- Use `[references/filename.md](references/filename.md)` for cross-references
  </action>
  <verify>
1. Run `wc -l .claude/skills/astro-cloudflare/SKILL.md` -- should be ~160-180 lines total (19 frontmatter + ~150 body)
2. Run `grep -c "^[0-9]\+\." .claude/skills/astro-cloudflare/SKILL.md` -- should return 10 (critical rules)
3. Run `grep -c "\\*\\*Default:\\*\\*" .claude/skills/astro-cloudflare/SKILL.md` -- should return 4 (one per decision matrix)
4. Run `grep "mcp__astro_doc__search_astro_docs" .claude/skills/astro-cloudflare/SKILL.md` -- should match at least once
5. Run `grep -c "^## " .claude/skills/astro-cloudflare/SKILL.md` -- should return 3 (Critical Rules, Decision Matrices, MCP Integration)
  </verify>
  <done>
SKILL.md body has 3 sections: Critical Rules with 10 numbered breaking-change imperatives, Decision Matrices with 4 tables each having a Default line, and MCP Integration with explicit use/don't-use boundary. Total body is ~150 lines.
  </done>
</task>

</tasks>

<verification>
- SKILL.md body is under 200 lines at this point (leaves 300+ for Plan 02)
- All 10 Astro 5.x breaking changes from research inventory are present
- All 4 decision matrices have Default lines with Cloudflare-appropriate defaults
- MCP section uses fully qualified tool name `mcp__astro_doc__search_astro_docs`
- No content duplicated from reference files beyond the 10 critical rules (which intentionally appear in both places)
</verification>

<success_criteria>
- Requirements CROSS-01 (anti-patterns table with breaking changes): COVERED
- Requirements CROSS-02 (decision matrices for 4 architectural choices): COVERED
- Requirements INTEG-01 (MCP integration instructions): COVERED
- Requirements INTEG-02 (skill vs MCP boundary): COVERED
- SKILL.md body total under 200 lines, well within 500-line budget
</success_criteria>

<output>
After completion, create `.planning/phases/05-skill-md-body/05-01-SUMMARY.md`
</output>
