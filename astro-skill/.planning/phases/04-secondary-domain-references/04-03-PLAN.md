---
phase: 04-secondary-domain-references
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/build-deploy.md
autonomous: true

must_haves:
  truths:
    - "Claude uses Workers with Static Assets as default deployment target, not Pages"
    - "Claude uses cloudflare/wrangler-action@v3 for CI/CD, not deprecated pages-action"
    - "Claude uses wrangler pages dev ./dist for preview, not astro preview (which skips Workers runtime)"
    - "Claude never uses output: 'hybrid' in Astro 5 config"
    - "Claude sets NODE_VERSION=22 in CI and uses correct build pipeline order"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/build-deploy.md"
      provides: "Build and deployment reference for Astro on Cloudflare"
      min_lines: 250
      contains: "Quick Reference"
  key_links:
    - from: "build-deploy.md"
      to: "Phase 2 cloudflare-platform.md"
      via: "cross-reference for wrangler.jsonc template"
      pattern: "cloudflare-platform"
    - from: "build-deploy.md"
      to: "Phase 2 rendering-modes.md"
      via: "cross-reference for output mode decisions"
      pattern: "rendering-modes"
---

<objective>
Write the `build-deploy.md` reference file covering wrangler dev/deploy workflow, package.json scripts, deployment target selection, CI/CD patterns, debugging tools, and VS Code configuration.

Purpose: Claude needs correct build/deploy knowledge for Astro on Cloudflare -- specifically the Workers-default deployment (Pages deprecated April 2025), wrangler-action v3 for CI, the critical distinction between `astro preview` and `wrangler pages dev`, and the removal of `output: 'hybrid'` in Astro 5.
Output: `references/build-deploy.md` (~300-350 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-secondary-domain-references/04-RESEARCH.md

# Phase 2-3 reference files -- match format and style
@.claude/skills/astro-cloudflare/references/project-structure.md
@.claude/skills/astro-cloudflare/references/components-islands.md

# Primary research sources
@docs/researchs/13 - Build et d√©ploiement.md
@docs/researchs/16 - DevX et tooling.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write build-deploy.md reference file</name>
  <files>.claude/skills/astro-cloudflare/references/build-deploy.md</files>
  <action>
Write `build-deploy.md` following the exact format established by Phase 2-3 reference files. Target ~300-350 lines. Content ratio: ~50% tables + ~50% code examples, minimal narrative prose.

**STRUCTURE (in order):**

1. **Title + subtitle** (1 line): `# Build and Deployment` + subtitle mentioning wrangler workflow, CI/CD, package.json scripts, debugging tools on Cloudflare Workers.

2. **Quick Reference** (~10-12 numbered imperative rules):
   Draw from Research 13 rules 9-15 and Research 16 rules 1-3. Must include:
   - Workers with Static Assets is default deployment target -- Pages deprecated April 2025
   - Use `cloudflare/wrangler-action@v3` in CI -- not deprecated `pages-action`
   - Set `NODE_VERSION=22` in CI environment -- required for Astro 5.x
   - Run `astro check` before `astro build` -- catches template type errors
   - Run `astro sync` after schema changes -- regenerates content types
   - Enable `platformProxy: { enabled: true }` for local dev with Cloudflare bindings
   - Use `imageService: 'compile'` -- Sharp is incompatible with Workers
   - Use `wrangler pages dev ./dist` for production-like preview -- `astro preview` does NOT use Workers runtime
   - Use `.assetsignore` in dist/ to exclude files from Workers Static Assets upload
   - Generate `ASTRO_KEY` with `astro create-key` for Server Islands in production
   - Never use `output: 'hybrid'` -- removed in Astro 5.0, use per-page `prerender` exports instead
   - Run `wrangler types` before `astro dev` to generate Cloudflare binding type definitions

3. **Output Mode Decision Matrix** (~6 rows table):
   Format: `| Scenario | Config | Key Setting |`
   Draw from Research 13 matrix 2. Cover: full static site, static with opt-out pages, full SSR, static-first with few SSR pages, API-only endpoints, mixed content site.

4. **Deployment Target Decision Matrix** (~4 rows table):
   Format: `| Situation | Target | Why |`
   Workers Static Assets (new projects) vs Pages (existing projects). Draw from Research 13.

5. **Dev/Preview Workflow Matrix** (~4 rows table):
   Format: `| Command | Runtime | Use When |`
   `astro dev` vs `wrangler pages dev ./dist` vs `astro preview`. Draw from Research 13 + Research 16.

6. **Package.json Scripts** (~15 lines code):
   Complete script set: dev, build, preview, typecheck, test:unit, test:e2e, deploy.
   Draw from the 04-RESEARCH code examples.

7. **GitHub Actions CI/CD** (~30 lines code):
   Full workflow: checkout, node 22, cache, build, deploy with wrangler-action. Branch previews with `--branch=` flag.
   Draw from Research 13 code GitHub Actions and the 04-RESEARCH code examples.

8. **Adapter Options Table** (~8 rows table):
   Format: `| Option | Default | Purpose |`
   All @astrojs/cloudflare adapter options. Draw from Research 13 reference 6.1.

9. **CLI Flags Reference** (~10 rows table):
   Format: `| Command | Flag | Purpose |`
   Useful astro + wrangler CLI commands. Draw from Research 13 reference 6.2 + Research 16 debugging guide.

10. **Debugging Workflow** (~15 lines):
    `wrangler --inspect`, `wrangler tail`, Chrome DevTools connection.
    Draw from Research 16 debugging guide.

11. **VS Code Config** (~15 lines code):
    Recommended settings: Astro extension, ESLint, Tailwind, formatting.
    Draw from Research 16 code VS Code settings.

12. **Anti-patterns** table (~10 rows):
    Format: `| Don't | Do | Severity |`
    CRITICAL/HIGH/MEDIUM tags. Must include:
    - CRITICAL: `output: 'hybrid'` -> removed in Astro 5, use per-page prerender
    - CRITICAL: `cloudflare/pages-action` in CI -> use `wrangler-action@v3`
    - CRITICAL: Sharp/node-canvas in project -> `imageService: 'compile'` or `'passthrough'`
    - HIGH: `process.env.VAR` for secrets -> `locals.runtime.env.VAR` on Workers
    - HIGH: `astro preview` for testing Workers -> `wrangler pages dev ./dist`
    - HIGH: `/functions` directory in project -> Astro handles server routes via adapter
    - MEDIUM: Skipping `astro check` in CI -> catches .astro template errors
    - MEDIUM: Manual `wrangler deploy` in CI -> use wrangler-action for caching/secrets

13. **Troubleshooting** table (~10 rows):
    Format: `| Symptom | Cause | Fix |`
    Astro-generic AND Cloudflare-specific:
    - `node:fs` error at runtime -> Workers has no native fs, use Cloudflare storage APIs
    - Sharp error during build -> remove sharp, use `imageService: 'compile'`
    - Bundle exceeds 25MB size limit -> audit dependencies, use `bundleAnalyzerReport`
    - CI syntax error on astro check -> missing `astro sync` step before check
    - Bindings undefined in dev -> `platformProxy: { enabled: true }` missing
    - Hydration mismatch in production -> Cloudflare Auto Minify enabled, disable it
    - Deploy succeeds but 404 -> wrong output directory or missing adapter
    - `ASTRO_KEY` error for Server Islands -> run `astro create-key` and add to environment
    - Build passes but runtime error -> tested with `astro preview` not Workers runtime
    - ESLint errors on .astro files -> needs eslint-plugin-astro + parser config

**CONTENT BOUNDARIES (from cross-domain assignment table):**
- DO include: wrangler dev/deploy workflow, package.json scripts, CI/CD GitHub Actions, debugging tools, VS Code config, adapter options, output mode decisions
- DO NOT include: wrangler.jsonc full template (in cloudflare-platform.md)
- DO NOT include: rendering mode decision matrix (in rendering-modes.md)
- DO NOT include: Vitest/testing config details (in typescript-testing.md)
- DO NOT include: security headers (in security-advanced.md)

**LANGUAGE:** English (matching Phase 2-3 files).
**TONE:** Imperative, direct, factual. No conversational prose.
  </action>
  <verify>
1. File exists at `.claude/skills/astro-cloudflare/references/build-deploy.md`
2. File has between 250-370 lines
3. File starts with `# Build and Deployment`
4. File contains `## Quick Reference` section with numbered rules
5. Contains at least 3 decision/reference tables
6. Contains at least 3 code blocks (package.json, GitHub Actions, VS Code config)
7. Contains `## Anti-patterns` table with CRITICAL/HIGH/MEDIUM tags
8. Contains `## Troubleshooting` table with Symptom/Cause/Fix columns
9. No mention of `output: 'hybrid'` as valid option (only in anti-patterns)
10. Contains `wrangler-action@v3` pattern
11. Contains `wrangler pages dev ./dist` for preview
12. Contains Workers as default deployment target
13. Does NOT contain full wrangler.jsonc template
14. Does NOT contain Vitest config details
  </verify>
  <done>
`build-deploy.md` exists with 250-370 lines, follows Phase 2-3 format (Quick Reference, decision matrices, code patterns, anti-patterns with severity tags, troubleshooting table), covers wrangler workflow, CI/CD, package.json scripts, debugging tools, VS Code config. Workers as default deployment target. All Astro 5.x APIs used correctly. No content duplication with Phase 2-3 or other Phase 4 files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify build-deploy.md quality and cross-references</name>
  <files>.claude/skills/astro-cloudflare/references/build-deploy.md</files>
  <action>
Read the completed file and verify:
1. Line count is 250-370
2. No Astro 4 deprecated patterns (`output: 'hybrid'` as valid config, `entry.slug`, `entry.render()`, `<ViewTransitions />`, `type: 'content'`)
3. No content that belongs in other Phase 2-4 files (wrangler.jsonc full template, rendering mode matrix, Vitest config, security headers)
4. All code examples use Astro 5.x API correctly
5. Troubleshooting table has at least 3 Cloudflare-specific entries (node:fs, Sharp, bundle size)
6. Quick Reference has 10-12 numbered rules in imperative tone
7. Anti-patterns table uses CRITICAL/HIGH/MEDIUM severity tags
8. Code comments follow convention: `// src/path/file.ts -- description` or YAML comments for workflows
9. Workers is presented as default deployment target throughout
10. `output: 'hybrid'` only appears in anti-patterns/troubleshooting, never as valid config

If any issues found, fix them in place.
  </action>
  <verify>Run line count on the file to confirm range. Grep for deprecated patterns to confirm absence from valid config sections.</verify>
  <done>File passes all quality checks: correct line count, no deprecated patterns in valid config, no cross-domain content leakage, Cloudflare-specific troubleshooting entries present.</done>
</task>

</tasks>

<verification>
- File follows Phase 2-3 format (Quick Reference, tables, code, anti-patterns, troubleshooting)
- Content boundaries respected per cross-domain assignment table
- All code examples use Astro 5.x API (no Astro 4 patterns)
- Both Astro-generic and Cloudflare-specific errors in troubleshooting
- ~300-350 lines, ~50% tables + ~50% code
</verification>

<success_criteria>
1. `build-deploy.md` covers output mode decisions for Astro 5
2. Workers as default deployment target, Pages as legacy option
3. Complete package.json scripts for Astro/Cloudflare workflow
4. GitHub Actions CI/CD with wrangler-action@v3
5. Dev/preview workflow matrix distinguishing astro preview from wrangler
6. Debugging workflow with wrangler --inspect and tail
7. Anti-patterns tagged CRITICAL/HIGH/MEDIUM
8. Troubleshooting table includes Cloudflare-specific errors
9. No content duplication with Phase 2-3 or other Phase 4 files
</success_criteria>

<output>
After completion, create `.planning/phases/04-secondary-domain-references/04-03-SUMMARY.md`
</output>
