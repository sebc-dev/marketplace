---
phase: 04-secondary-domain-references
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/security-advanced.md
autonomous: true

must_haves:
  truths:
    - "Claude adds security headers via middleware for SSR routes because _headers file is ignored for dynamic responses"
    - "Claude uses xss (js-xss) library for sanitization on Workers instead of DOMPurify (requires jsdom)"
    - "Claude accesses secrets via locals.runtime.env on Workers, not import.meta.env for server-side secrets"
    - "Claude configures remark/rehype plugins in markdown.* config because MDX inherits from it"
    - "Claude places rehypeHeadingIds before rehypeAutolinkHeadings in plugin array"
    - "Claude uses defaultColor: false for Shiki dual-theme CSS and targets .astro-code not .shiki class"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/security-advanced.md"
      provides: "Security and advanced MDX/Markdoc reference for Astro on Cloudflare"
      min_lines: 280
      contains: "Quick Reference"
  key_links:
    - from: "security-advanced.md"
      to: "Phase 3 routing-navigation.md"
      via: "extends basic middleware authCheck stub with full auth pattern"
      pattern: "routing-navigation"
    - from: "security-advanced.md"
      to: "Phase 3 data-content.md"
      via: "extends basic MDX/Markdoc decision with advanced setup"
      pattern: "data-content"
    - from: "security-advanced.md"
      to: "Phase 2 cloudflare-platform.md"
      via: "extends .dev.vars basics with full secrets management"
      pattern: "cloudflare-platform"
---

<objective>
Write the `security-advanced.md` reference file covering CSP on Cloudflare, auth patterns with middleware, Astro Actions security, secrets management, and MDX/Markdoc advanced setup (custom components, remark/rehype plugins, Shiki dual themes, Markdoc custom tags).

Purpose: Claude needs correct security and advanced content authoring knowledge for Astro/Cloudflare -- specifically the non-obvious _headers limitation for SSR, Workers-compatible sanitization (xss not DOMPurify), secrets via runtime.env, and the precise remark/rehype plugin ordering that breaks heading autolinks if wrong. This file fulfills content explicitly deferred from Phase 3 (middleware auth from routing-navigation, Actions CSRF from data-content, MDX advanced from data-content).
Output: `references/security-advanced.md` (~320-370 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-secondary-domain-references/04-RESEARCH.md

# Phase 2-3 reference files -- match format and style
@.claude/skills/astro-cloudflare/references/project-structure.md
@.claude/skills/astro-cloudflare/references/components-islands.md

# Phase 3 files with explicit deferrals to this file
@.claude/skills/astro-cloudflare/references/routing-navigation.md
@.claude/skills/astro-cloudflare/references/data-content.md

# Primary research sources
@docs/researchs/15 - Sécurité.md
@docs/researchs/18 - Markdown MDX Markdoc.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write security-advanced.md reference file</name>
  <files>.claude/skills/astro-cloudflare/references/security-advanced.md</files>
  <action>
Write `security-advanced.md` following the exact format established by Phase 2-3 reference files. Target ~320-370 lines. Content ratio: ~50% tables + ~50% code examples, minimal narrative prose. This is the largest Phase 4 file due to dual domain (security + MDX/Markdoc advanced).

**CRITICAL CONTEXT:** Phase 3 explicitly deferred these topics here:
- [03-02 decision]: Middleware authCheck was kept as basic redirect example in routing-navigation.md -- full auth pattern goes here
- [03-03 decision]: Actions kept to basic signature and decision matrix -- CSRF/validation goes here
- [03-03 content]: data-content.md line 163 says "CSRF protection and advanced validation patterns belong in security-advanced.md (Phase 4)"

**STRUCTURE (in order):**

1. **Title + subtitle** (1 line): `# Security and Advanced Patterns` + subtitle mentioning CSP, auth middleware, Actions security, secrets, MDX/Markdoc advanced setup on Cloudflare Workers.

2. **Quick Reference** (~12-14 numbered imperative rules):
   Draw from Research 15 rules and Research 18 rules 1-8. Must include:
   - `_headers` file is ignored for SSR dynamic routes -- use middleware for security headers
   - `checkOrigin: true` is default in Astro 5 but does NOT protect JSON API endpoints
   - Never use `set:html` on user-provided content -- bypasses all escaping
   - Access secrets via `locals.runtime.env.SECRET` on Workers -- not `import.meta.env.SECRET` (undefined SSR)
   - Use `xss` (js-xss) library for HTML sanitization on Workers -- DOMPurify needs jsdom
   - `experimental.csp` config is incompatible with ClientRouter (View Transitions)
   - `frame-ancestors` only works via HTTP header, not `<meta>` CSP tag
   - MDX inherits all config from `markdown.*` -- do NOT duplicate plugins in `mdx()` config
   - Place `rehypeHeadingIds` before `rehypeAutolinkHeadings` in plugin array -- IDs must exist before autolink
   - Set `defaultColor: false` in shikiConfig for CSS-driven dual theme switching
   - Target `.astro-code` not `.shiki` for Shiki CSS class styling in Astro 5
   - Use `file.data.astro.frontmatter` in remark plugins to access/modify frontmatter

3. **Security Decision Matrix** (~6 rows table):
   Format: `| Deployment Mode | CSP | CSRF | Headers | Secrets |`
   SSG vs SSR vs hybrid-replacement approach for each concern.
   Draw from Research 15 matrix.

4. **Security Headers Middleware** (~25 lines code):
   Complete middleware with X-Frame-Options, HSTS, Permissions-Policy, CORS OPTIONS handler, `sequence()` composition with auth.
   Draw from Research 15 code 2 and the 04-RESEARCH code examples.

5. **Auth Middleware Pattern** (~15 lines code):
   Cookie-based session verification extending the basic routing-navigation.md stub. `sequence()` composition. Prerender guard pattern.
   Draw from the 04-RESEARCH code examples.

6. **Actions Security Pattern** (~15 lines code):
   Zod validation + `xss` sanitization for user input on Cloudflare Workers. Note about `checkOrigin` JSON limitation.
   Draw from Research 15 code 4.

7. **Secrets Management** (~15 lines code):
   `astro:env` schema + `.dev.vars` for local + `wrangler secret put` for production.
   Draw from Research 15 code 5-6. Cross-reference cloudflare-platform.md for .dev.vars basics.

8. **CSP Config** (~10 lines code):
   `experimental.csp` in astro.config.mjs with note about ClientRouter incompatibility.
   Draw from Research 15 code 1.

9. **MDX/Markdoc Advanced Setup** header (clear section break for dual-domain file)

10. **Remark/Rehype Plugin Config** (~20 lines code):
    astro.config.mjs markdown.* config with correct plugin ordering. Emphasis on rehypeHeadingIds before autolink.
    Draw from Research 18 code and the 04-RESEARCH code examples.

11. **Custom Component Mapping** (~15 lines code):
    MDX `<Content components={{ h2: Heading }} />` pattern for styling markdown output.
    Draw from Research 18 code MDX components.

12. **Markdoc Custom Tags** (~15 lines code):
    `markdoc.config.mjs` with `component()` helper. `{% tag %}` syntax.
    Draw from Research 18 code Markdoc.

13. **Shiki Dual Theme CSS** (~10 lines code):
    CSS for `.astro-code` with `--shiki-dark` CSS variables, `defaultColor: false`.
    Draw from Research 18 code CSS.

14. **Custom Remark Plugin** (~10 lines code):
    `file.data.astro.frontmatter` access pattern, reading-time example.
    Draw from Research 18 code remark plugin.

15. **Anti-patterns** table (~12 rows):
    Format: `| Don't | Do | Severity |`
    CRITICAL/HIGH/MEDIUM tags. Must include:
    - CRITICAL: `import.meta.env.SECRET` on Workers SSR -> `locals.runtime.env.SECRET`
    - CRITICAL: `set:html` on user content -> sanitize with `xss` library first
    - CRITICAL: `unsafe-inline` in CSP -> use nonces or hashes
    - HIGH: `_headers` for SSR security headers -> middleware
    - HIGH: DOMPurify on Workers -> `xss` (js-xss) library
    - HIGH: Duplicate remarkPlugins in `markdown.*` AND `mdx()` -> MDX inherits from markdown
    - HIGH: HTML comments `<!-- -->` in MDX files -> cause parsing errors, use `{/* JSX comments */}`
    - HIGH: `.shiki` CSS class target -> `.astro-code` in Astro 5
    - MEDIUM: `CORS: *` with credentials -> specific origin required
    - MEDIUM: Sourcemaps in production -> expose source code
    - MEDIUM: `defaultColor: 'dark'` for Shiki -> `defaultColor: false` for CSS switching
    - MEDIUM: Remark plugin reading `data.frontmatter` -> `data.astro.frontmatter` in Astro

16. **Troubleshooting** table (~10 rows):
    Format: `| Symptom | Cause | Fix |`
    Astro-generic AND Cloudflare-specific:
    - CSP blocks inline scripts -> Cloudflare Auto Minify or missing nonce
    - `_headers` rules not applied to SSR route -> expected: only static assets use `_headers`
    - CORS preflight returns 404 -> missing OPTIONS handler in middleware
    - Shiki theme unchanged after config edit -> clear Vite cache (`.astro/`)
    - MDX parsing error on `<Component />` -> missing import or using HTML comment syntax
    - Markdoc `{% tag %}` not rendering -> missing config in markdoc.config.mjs
    - Heading links broken (autolink) -> rehypeHeadingIds must be before rehypeAutolinkHeadings
    - `import.meta.env.SECRET` is undefined -> on Workers SSR, use `locals.runtime.env`
    - `xss is not a function` -> import as `import xss from 'xss'` (default export)
    - `checkOrigin` error on JSON POST -> checkOrigin only validates form submissions, add manual CSRF for JSON

**CONTENT BOUNDARIES (from cross-domain assignment table):**
- DO include: CSP, security headers middleware, auth middleware (full pattern), Actions CSRF/validation, secrets management, remark/rehype config, MDX custom components, Markdoc custom tags, Shiki dual theme, custom remark plugins
- DO NOT include: basic middleware syntax (in routing-navigation.md)
- DO NOT include: basic MDX/Markdoc decision matrix (in data-content.md)
- DO NOT include: Content Layer API (in data-content.md)
- DO NOT include: basic .dev.vars explanation (in cloudflare-platform.md)
- DO NOT include: Vitest/testing patterns (in typescript-testing.md)

**LANGUAGE:** English (matching Phase 2-3 files).
**TONE:** Imperative, direct, factual. No conversational prose.
  </action>
  <verify>
1. File exists at `.claude/skills/astro-cloudflare/references/security-advanced.md`
2. File has between 280-390 lines
3. File starts with `# Security and Advanced Patterns`
4. File contains `## Quick Reference` section with numbered rules
5. Contains at least 2 decision/reference tables
6. Contains at least 6 code blocks (middleware, auth, actions, secrets, remark/rehype, MDX components, Markdoc, Shiki CSS)
7. Contains `## Anti-patterns` table with CRITICAL/HIGH/MEDIUM tags
8. Contains `## Troubleshooting` table with Symptom/Cause/Fix columns
9. No mention of `output: 'hybrid'` (removed in Astro 5)
10. Contains `_headers` limitation for SSR
11. Contains `xss` library recommendation (not DOMPurify)
12. Contains `locals.runtime.env` pattern for secrets
13. Contains `rehypeHeadingIds` before `rehypeAutolinkHeadings` ordering
14. Contains `.astro-code` CSS class (not `.shiki`)
15. Contains `defaultColor: false` for Shiki
16. Contains `sequence()` for middleware composition
17. Does NOT contain basic Content Layer API patterns
18. Does NOT contain Vitest config
  </verify>
  <done>
`security-advanced.md` exists with 280-390 lines, follows Phase 2-3 format (Quick Reference, decision matrices, code patterns, anti-patterns with severity tags, troubleshooting table), covers CSP, security headers middleware, auth patterns, Actions CSRF/validation, secrets management, remark/rehype plugins, MDX custom components, Markdoc tags, Shiki dual themes. Fulfills all Phase 3 deferred content. All Astro 5.x APIs used correctly. No content duplication with Phase 2-3 or other Phase 4 files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify security-advanced.md quality and deferred content coverage</name>
  <files>.claude/skills/astro-cloudflare/references/security-advanced.md</files>
  <action>
Read the completed file and verify:
1. Line count is 280-390
2. No Astro 4 deprecated patterns (`output: 'hybrid'`, `entry.slug`, `entry.render()`, `<ViewTransitions />`, `type: 'content'`)
3. No content that belongs in other Phase 2-4 files (basic middleware syntax, basic MDX decision, Content Layer, .dev.vars intro, Vitest)
4. All code examples use Astro 5.x API correctly
5. Troubleshooting table has at least 3 Cloudflare-specific entries (_headers ignored, import.meta.env undefined, Auto Minify CSP)
6. Quick Reference has 12-14 numbered rules in imperative tone
7. Anti-patterns table uses CRITICAL/HIGH/MEDIUM severity tags
8. Code comments follow convention: `// src/path/file.ts -- description`

**DEFERRED CONTENT CHECK (critical):**
9. Contains full auth middleware pattern (deferred from routing-navigation.md [03-02])
10. Contains Actions CSRF/validation pattern with xss sanitization (deferred from data-content.md [03-03])
11. Contains MDX custom component mapping pattern (deferred from data-content.md)
12. Contains remark/rehype plugin configuration (deferred from data-content.md)
13. Contains Markdoc custom tags config (deferred from data-content.md)

If any issues found, fix them in place.
  </action>
  <verify>Run line count on the file to confirm range. Grep for deprecated patterns to confirm absence. Grep for deferred content markers to confirm coverage.</verify>
  <done>File passes all quality checks: correct line count, no deprecated patterns, no cross-domain content leakage, all Phase 3 deferred content present, Cloudflare-specific troubleshooting entries present.</done>
</task>

</tasks>

<verification>
- File follows Phase 2-3 format (Quick Reference, tables, code, anti-patterns, troubleshooting)
- Content boundaries respected per cross-domain assignment table
- All Phase 3 deferred content included (auth middleware, Actions CSRF, MDX advanced, remark/rehype, Markdoc)
- All code examples use Astro 5.x API (no Astro 4 patterns)
- Both Astro-generic and Cloudflare-specific errors in troubleshooting
- ~320-370 lines, dual domain balanced (~200 security + ~120 MDX/Markdoc)
</verification>

<success_criteria>
1. `security-advanced.md` covers CSP with experimental config and ClientRouter limitation
2. Security headers middleware with sequence() composition
3. Full auth middleware pattern extending routing-navigation.md stub
4. Actions CSRF/validation with xss sanitization (Workers-compatible)
5. Secrets management via runtime.env (not import.meta.env)
6. Remark/rehype plugin config with correct ordering (rehypeHeadingIds first)
7. MDX custom component mapping pattern
8. Markdoc custom tags with markdoc.config.mjs
9. Shiki dual theme CSS with .astro-code and defaultColor: false
10. Anti-patterns tagged CRITICAL/HIGH/MEDIUM
11. Troubleshooting table includes Cloudflare-specific errors
12. No content duplication with Phase 2-3 or other Phase 4 files
</success_criteria>

<output>
After completion, create `.planning/phases/04-secondary-domain-references/04-04-SUMMARY.md`
</output>
