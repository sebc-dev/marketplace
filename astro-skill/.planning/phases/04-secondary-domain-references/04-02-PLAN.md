---
phase: 04-secondary-domain-references
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/typescript-testing.md
autonomous: true

must_haves:
  truths:
    - "Claude uses getViteConfig() from astro/config for Vitest setup instead of standard defineConfig"
    - "Claude uses experimental_AstroContainer for component testing with correct import"
    - "Claude uses @cloudflare/vitest-pool-workers for testing code that accesses Cloudflare bindings"
    - "Claude sets moduleResolution to Bundler in tsconfig instead of node"
    - "Claude runs astro sync before tsc to ensure generated types are available"
    - "Claude uses Vitest 3.x with Astro projects, not Vitest 4.x"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/typescript-testing.md"
      provides: "TypeScript and testing reference for Astro on Cloudflare"
      min_lines: 250
      contains: "Quick Reference"
  key_links:
    - from: "typescript-testing.md"
      to: "Phase 2 project-structure.md"
      via: "cross-reference for tsconfig.json and env.d.ts basics"
      pattern: "project-structure"
    - from: "typescript-testing.md"
      to: "Phase 2 cloudflare-platform.md"
      via: "cross-reference for Cloudflare binding types"
      pattern: "cloudflare-platform"
---

<objective>
Write the `typescript-testing.md` reference file covering Astro TypeScript configuration, env.d.ts patterns, Cloudflare binding type safety, Vitest setup, Container API testing, and practical test patterns.

Purpose: Claude needs correct TypeScript and testing knowledge for Astro/Cloudflare projects -- specifically the non-obvious getViteConfig requirement, experimental Container API import, Cloudflare vitest-pool-workers, and Vitest 3.x version constraint that break tests if wrong.
Output: `references/typescript-testing.md` (~300-340 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-secondary-domain-references/04-RESEARCH.md

# Phase 2-3 reference files -- match format and style
@.claude/skills/astro-cloudflare/references/project-structure.md
@.claude/skills/astro-cloudflare/references/components-islands.md

# Primary research sources
@docs/researchs/11 - TypeScript.md
@docs/researchs/12 - Testing.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write typescript-testing.md reference file</name>
  <files>.claude/skills/astro-cloudflare/references/typescript-testing.md</files>
  <action>
Write `typescript-testing.md` following the exact format established by Phase 2-3 reference files. Target ~300-340 lines. Content ratio: ~50% tables + ~50% code examples, minimal narrative prose.

**STRUCTURE (in order):**

1. **Title + subtitle** (1 line): `# TypeScript and Testing` + subtitle mentioning TypeScript config, env.d.ts, Cloudflare types, Vitest, Container API on Cloudflare Workers.

2. **Quick Reference** (~12-14 numbered imperative rules):
   Draw from Research 11 rules 1-14 and Research 12 rules 1-8. Must include:
   - Include `.astro/types.d.ts` in tsconfig `include` array -- generated types for content collections
   - Run `astro sync` before `tsc --noEmit` -- generates `.astro/types.d.ts`
   - Use `moduleResolution: "Bundler"` -- not `"node"` (breaks Astro imports)
   - Declare `App.Locals extends Runtime<Env>` in env.d.ts for type-safe Cloudflare bindings
   - Run `astro check && tsc --noEmit` for full type validation
   - Use `satisfies APIRoute` for API route type safety
   - Import `Runtime<Env>` from `@astrojs/cloudflare` -- not manual typing
   - Use `getViteConfig()` from `astro/config` for Vitest -- not standard `defineConfig`
   - Import `experimental_AstroContainer` from `astro/container` -- not `AstroContainer`
   - Use `@cloudflare/vitest-pool-workers` for tests that need real Cloudflare bindings
   - Pin Vitest to 3.x -- Vitest 4.x is incompatible with Astro 5.x
   - Use `environment: 'node'` in vitest config for unit tests -- not `happy-dom` (breaks Astro transforms)
   - Add `globals: true` in vitest config to avoid importing describe/test/expect everywhere

3. **TypeScript Config Decision Matrix** (~6 rows table):
   Format: `| Scenario | Preset | Key Settings |`
   Draw from Research 11 matrix 2. Cover: quick prototype, standard project, production app, library/package, strict team, content-only site.

4. **env.d.ts Full Pattern** (~20 lines code):
   Complete type-safe env.d.ts with `App.Locals extends Runtime<Env>`, `Env` interface with D1/KV/R2/secrets, `App.SessionData`.
   Draw from Research 11 code 3 and the 04-RESEARCH code examples.

5. **Test Type Decision Matrix** (~10 rows table):
   Format: `| What to Test | Tool | Why |`
   Draw from Research 12 matrix 2. Cover: Astro component rendering, React/Vue island, API route, Astro Action, Content Collection, middleware, Cloudflare binding logic, E2E flow, visual regression, SSR output.

6. **Vitest Config** (~15 lines code):
   `getViteConfig()` pattern with node environment.
   Draw from Research 12 code vitest.config and the 04-RESEARCH code examples.

7. **Container API Test** (~20 lines code):
   Testing Astro component with props, slots, and named slots using experimental_AstroContainer.
   Draw from Research 12 code container and the 04-RESEARCH code examples.

8. **Cloudflare Bindings Test** (~15 lines code):
   `@cloudflare/vitest-pool-workers` with `defineWorkersConfig` pattern.
   Draw from Research 12 code mock-bindings.

9. **Playwright Config** (~10 lines code):
   `wrangler pages dev ./dist` as webServer for E2E.
   Draw from Research 12 code playwright.

10. **Anti-patterns** table (~10 rows):
    Format: `| Don't | Do | Severity |`
    CRITICAL/HIGH/MEDIUM tags. Must include:
    - CRITICAL: `defineConfig` for Vitest with Astro -> `getViteConfig()` from `astro/config`
    - CRITICAL: `moduleResolution: "node"` -> `"Bundler"` required for Astro imports
    - CRITICAL: Vitest 4.x with Astro 5.x -> pin to Vitest 3.x
    - HIGH: `AstroContainer` import -> `experimental_AstroContainer`
    - HIGH: `happy-dom` for all tests -> `environment: 'node'` for unit, `happy-dom` only for DOM testing
    - HIGH: Manual Cloudflare binding mocks -> `@cloudflare/vitest-pool-workers`
    - MEDIUM: Skip `astro check` in CI -> catches template type errors tsc misses
    - MEDIUM: `astro preview` for E2E tests -> `wrangler pages dev ./dist` to test Workers runtime

11. **Troubleshooting** table (~10 rows):
    Format: `| Symptom | Cause | Fix |`
    Astro-generic AND Cloudflare-specific:
    - `astro:content` not found -> `astro sync` not run or missing content.config.ts
    - `runtime` undefined in prerender page -> prerendered pages have no Workers runtime
    - Vitest shows `[object Object]` -> using `defineConfig` instead of `getViteConfig`
    - Container missing renderers -> add `renderers` option for framework components
    - Types stale after schema change -> run `astro sync` to regenerate
    - `Cannot find module` in Vitest -> `moduleResolution` set to `"node"` instead of `"Bundler"`
    - E2E tests pass locally but fail in CI -> using `astro preview` instead of `wrangler pages dev`
    - `env.DB is undefined` in test -> need `@cloudflare/vitest-pool-workers` not standard vitest
    - Type error on `Astro.locals.runtime` -> missing `App.Locals extends Runtime<Env>` declaration
    - `astro check` finds errors tsc misses -> expected: astro check validates .astro templates

**CONTENT BOUNDARIES (from cross-domain assignment table):**
- DO include: tsconfig patterns, env.d.ts with Cloudflare types, Vitest config, Container API, Cloudflare pool workers, Playwright config, package.json test scripts
- DO NOT include: wrangler.jsonc template (in cloudflare-platform.md)
- DO NOT include: deployment/CI scripts (in build-deploy.md)
- DO NOT include: ESLint/Prettier config (in build-deploy.md)
- DO NOT include: Content Layer API details (in data-content.md)

**LANGUAGE:** English (matching Phase 2-3 files).
**TONE:** Imperative, direct, factual. No conversational prose.
  </action>
  <verify>
1. File exists at `.claude/skills/astro-cloudflare/references/typescript-testing.md`
2. File has between 250-360 lines
3. File starts with `# TypeScript and Testing`
4. File contains `## Quick Reference` section with numbered rules
5. Contains at least 2 decision matrix tables
6. Contains at least 4 code blocks (env.d.ts, vitest.config, container test, bindings test)
7. Contains `## Anti-patterns` table with CRITICAL/HIGH/MEDIUM tags
8. Contains `## Troubleshooting` table with Symptom/Cause/Fix columns
9. No mention of `output: 'hybrid'` (removed in Astro 5)
10. Contains `getViteConfig` pattern (not defineConfig)
11. Contains `experimental_AstroContainer` (not AstroContainer)
12. Contains `@cloudflare/vitest-pool-workers` mention
13. Contains `moduleResolution: "Bundler"` pattern
14. Does NOT contain wrangler.jsonc template
15. Does NOT contain ESLint/Prettier config
  </verify>
  <done>
`typescript-testing.md` exists with 250-360 lines, follows Phase 2-3 format (Quick Reference, decision matrices, code patterns, anti-patterns with severity tags, troubleshooting table), covers TypeScript config, env.d.ts, Vitest setup, Container API, Cloudflare bindings testing. All Astro 5.x APIs used correctly. No content duplication with Phase 2-3 or other Phase 4 files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify typescript-testing.md quality and cross-references</name>
  <files>.claude/skills/astro-cloudflare/references/typescript-testing.md</files>
  <action>
Read the completed file and verify:
1. Line count is 250-360
2. No Astro 4 deprecated patterns (`output: 'hybrid'`, `entry.slug`, `entry.render()`, `<ViewTransitions />`, `type: 'content'`)
3. No content that belongs in other Phase 2-4 files (wrangler.jsonc, deployment CI, ESLint, Content Layer)
4. All code examples use Astro 5.x API correctly
5. Troubleshooting table has at least 2 Cloudflare-specific entries (runtime undefined, vitest-pool-workers)
6. Quick Reference has 12-14 numbered rules in imperative tone
7. Anti-patterns table uses CRITICAL/HIGH/MEDIUM severity tags
8. Code comments follow convention: `// src/path/file.ts -- description`
9. Uses `getViteConfig()` not `defineConfig` for Vitest
10. Uses `experimental_AstroContainer` not `AstroContainer`

If any issues found, fix them in place.
  </action>
  <verify>Run line count on the file to confirm range. Grep for deprecated patterns to confirm absence.</verify>
  <done>File passes all quality checks: correct line count, no deprecated patterns, no cross-domain content leakage, Cloudflare-specific troubleshooting entries present.</done>
</task>

</tasks>

<verification>
- File follows Phase 2-3 format (Quick Reference, tables, code, anti-patterns, troubleshooting)
- Content boundaries respected per cross-domain assignment table
- All code examples use Astro 5.x API (no Astro 4 patterns)
- Both Astro-generic and Cloudflare-specific errors in troubleshooting
- ~300-340 lines, ~50% tables + ~50% code
</verification>

<success_criteria>
1. `typescript-testing.md` covers TypeScript config with preset decision matrix
2. env.d.ts pattern with full Cloudflare binding type safety
3. Vitest config with getViteConfig() and correct environment
4. Container API test pattern with experimental import
5. Cloudflare bindings test pattern with vitest-pool-workers
6. Playwright E2E config with wrangler preview
7. Anti-patterns tagged CRITICAL/HIGH/MEDIUM
8. Troubleshooting table includes Cloudflare-specific errors
9. No content duplication with Phase 2-3 or other Phase 4 files
</success_criteria>

<output>
After completion, create `.planning/phases/04-secondary-domain-references/04-02-SUMMARY.md`
</output>
