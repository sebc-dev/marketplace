---
phase: 04-secondary-domain-references
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/seo-i18n.md
autonomous: true

must_haves:
  truths:
    - "Claude always sets site in astro.config.mjs before using sitemap, RSS, or canonical URLs"
    - "Claude generates correct hreflang tags with x-default for multilingual Astro sites on Cloudflare"
    - "Claude uses prefixDefaultLocale: true with redirectToDefaultLocale: false to avoid redirect loops"
    - "Claude builds SEO components manually instead of using unmaintained astro-seo package"
    - "Claude uses workers-og for dynamic OG images instead of Sharp on Cloudflare Workers"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/seo-i18n.md"
      provides: "SEO and i18n reference for Astro on Cloudflare"
      min_lines: 250
      contains: "Quick Reference"
  key_links:
    - from: "seo-i18n.md"
      to: "Phase 2 project-structure.md"
      via: "cross-reference for astro.config.mjs site property"
      pattern: "project-structure"
    - from: "seo-i18n.md"
      to: "Phase 3 routing-navigation.md"
      via: "cross-reference for i18n routing basics"
      pattern: "routing-navigation"
---

<objective>
Write the `seo-i18n.md` reference file covering SEO meta tags, sitemap, OpenGraph, structured data, i18n routing, hreflang patterns, and language detection for Astro on Cloudflare.

Purpose: Claude needs correct knowledge for SEO implementation (canonical URLs, OG images, JSON-LD, sitemap) and internationalization (routing config, hreflang, language detection) on Cloudflare-hosted Astro sites -- areas where outdated library recommendations and Cloudflare-specific constraints cause frequent errors.
Output: `references/seo-i18n.md` (~280-320 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-secondary-domain-references/04-RESEARCH.md

# Phase 2-3 reference files -- match format and style
@.claude/skills/astro-cloudflare/references/project-structure.md
@.claude/skills/astro-cloudflare/references/components-islands.md

# Primary research sources
@docs/researchs/9 - SEO et métadonnées.md
@docs/researchs/10 - Internationalisation.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write seo-i18n.md reference file</name>
  <files>.claude/skills/astro-cloudflare/references/seo-i18n.md</files>
  <action>
Write `seo-i18n.md` following the exact format established by Phase 2-3 reference files. Target ~280-320 lines. Content ratio: ~50% tables + ~50% code examples, minimal narrative prose.

**STRUCTURE (in order):**

1. **Title + subtitle** (1 line): `# SEO and Internationalization` + subtitle mentioning meta tags, sitemap, OpenGraph, structured data, i18n routing, hreflang on Cloudflare.

2. **Quick Reference** (~10-12 numbered imperative rules):
   Draw from Research 9 rules 1-8 and Research 10 rules 1-6. Must include:
   - Always define `site` in astro.config.mjs -- required by sitemap, RSS, canonical URLs
   - Use `new URL(Astro.url.pathname, Astro.site)` for canonical URLs -- never hardcode localhost
   - Use `set:html={JSON.stringify(schema)}` for JSON-LD -- not template literal injection
   - Set `trailingSlash: 'never'` in config to avoid duplicate canonical URLs
   - Prerender SEO endpoints (sitemap, RSS, robots.txt) with `export const prerender = true`
   - Use `workers-og` for dynamic OG images on Cloudflare Workers -- Sharp/resvg incompatible
   - Always use absolute URLs for og:image -- relative URLs fail on social platforms
   - Set `prefixDefaultLocale: true` for consistent URL structure across all locales
   - Set `redirectToDefaultLocale: false` to prevent redirect loops on Cloudflare
   - Use `Astro.currentLocale` to detect locale -- not `Astro.preferredLocale` (returns Accept-Language, not URL)
   - Generate x-default hreflang manually -- no Astro library generates it automatically
   - Use Paraglide (Inlang) for translations on Workers -- astro-i18next abandoned 3 years

3. **SEO Component Pattern** (~25 lines code):
   Reusable `<SEOHead />` component with canonical URL, OG tags, Twitter Card.
   Draw from Research 9 code 5.1 and the 04-RESEARCH code examples.

4. **Sitemap Config** (~15 lines):
   `@astrojs/sitemap` with filter + serialize options. Note custom endpoint needed for full SSR dynamic routes.
   Draw from Research 9 code 5.2.

5. **JSON-LD Structured Data** (~15 lines code):
   `set:html` pattern with `@graph` structure. Mention `schema-dts` for optional typing.
   Draw from Research 9 code 5.4.

6. **RSS Endpoint** (~15 lines code):
   Content Collections + `@astrojs/rss` with prerender = true for Cloudflare.
   Draw from Research 9 code 5.3 and the 04-RESEARCH code examples.

7. **i18n Config** (~15 lines code):
   `prefixDefaultLocale: true` + `redirectToDefaultLocale: false` combo.
   Draw from Research 10 code 6.1.

8. **Hreflang Component** (~20 lines code):
   Self-referencing canonical + all locale alternates + x-default.
   Draw from Research 10 code 6.4 and the 04-RESEARCH code examples.

9. **Translation Decision Matrix** (~6 rows table):
   Format: `| Scenario | Solution | Why |`
   Draw from Research 10 matrix 3. Cover: 2 languages manual JSON, 3+ languages Paraglide, content-heavy i18n, URL-only i18n, CMS-driven translations.

10. **Anti-patterns** table (~10 rows):
    Format: `| Don't | Do | Severity |`
    CRITICAL/HIGH/MEDIUM tags. Must include:
    - CRITICAL: Missing `site` in config -> sitemap/canonical breaks
    - CRITICAL: `redirectToDefaultLocale: true` -> redirect loop on Cloudflare
    - HIGH: Using `astro-seo` package -> unmaintained 2+ years, use manual component
    - HIGH: Relative og:image URLs -> absolute URLs required
    - HIGH: `Astro.preferredLocale` for routing -> use `Astro.currentLocale`
    - MEDIUM: Using `astro-i18next` -> abandoned, Workers-incompatible
    - MEDIUM: JSON-LD with template literals -> use `set:html` + `JSON.stringify`
    - MEDIUM: Missing `Vary: Accept-Language` header on CF -> SSR language detection caching issue

11. **Troubleshooting** table (~8 rows):
    Format: `| Symptom | Cause | Fix |`
    Astro-generic AND Cloudflare-specific:
    - Sitemap returns 404 -> missing prerender = true on SSR site
    - Canonical URL shows localhost -> missing `site` in astro.config.mjs
    - JSON-LD not detected by Google -> using innerHTML instead of `set:html`
    - Wrong language served on Cloudflare -> missing Vary header, CF caching based on URL only
    - 404 with i18n SSR routing -> missing fallback route for locale prefix
    - OG image not rendering -> relative URL or Sharp used on Workers
    - Redirect loop on locale switch -> `redirectToDefaultLocale: true` with prefix config
    - RSS feed empty -> using `getCollection` without filtering drafts

**CONTENT BOUNDARIES (from cross-domain assignment table):**
- DO include: SEO meta tags, sitemap, OpenGraph, JSON-LD, canonical URLs, RSS, i18n routing config, hreflang, language detection middleware, translation solution decision
- DO NOT include: file-based routing details (in routing-navigation.md)
- DO NOT include: middleware patterns beyond language detection (in routing-navigation.md / security-advanced.md)
- DO NOT include: Content Layer API details (in data-content.md)
- DO NOT include: CSP headers (in security-advanced.md)

**LANGUAGE:** English (matching Phase 2-3 files).
**TONE:** Imperative, direct, factual. No conversational prose.
  </action>
  <verify>
1. File exists at `.claude/skills/astro-cloudflare/references/seo-i18n.md`
2. File has between 250-340 lines
3. File starts with `# SEO and Internationalization`
4. File contains `## Quick Reference` section with numbered rules
5. Contains at least 2 decision/reference tables
6. Contains at least 4 code blocks (SEOHead, JSON-LD, RSS, hreflang)
7. Contains `## Anti-patterns` table with CRITICAL/HIGH/MEDIUM tags
8. Contains `## Troubleshooting` table with Symptom/Cause/Fix columns
9. No mention of `output: 'hybrid'` (removed in Astro 5)
10. No mention of `entry.slug` (replaced by `entry.id`)
11. Contains `prefixDefaultLocale: true` and `redirectToDefaultLocale: false`
12. Contains `workers-og` mention for OG images
13. Contains `set:html` pattern for JSON-LD
14. Does NOT contain CSP content
15. Does NOT contain middleware auth patterns
  </verify>
  <done>
`seo-i18n.md` exists with 250-340 lines, follows Phase 2-3 format (Quick Reference, decision matrices, code patterns, anti-patterns with severity tags, troubleshooting table), covers SEO meta/sitemap/OG/JSON-LD and i18n routing/hreflang/translations. All Astro 5.x APIs used correctly. No content duplication with Phase 2-3 or other Phase 4 files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify seo-i18n.md quality and cross-references</name>
  <files>.claude/skills/astro-cloudflare/references/seo-i18n.md</files>
  <action>
Read the completed file and verify:
1. Line count is 250-340
2. No Astro 4 deprecated patterns (`output: 'hybrid'`, `entry.slug`, `entry.render()`, `<ViewTransitions />`, `type: 'content'`)
3. No content that belongs in other Phase 3-4 files (middleware auth, CSP, Content Layer details, routing details)
4. All code examples use Astro 5.x API correctly
5. Troubleshooting table has at least 2 Cloudflare-specific entries (Workers OG, Vary header caching)
6. Quick Reference has 10-12 numbered rules in imperative tone
7. Anti-patterns table uses CRITICAL/HIGH/MEDIUM severity tags
8. Code comments follow convention: `// src/path/file.ts -- description`

If any issues found, fix them in place.
  </action>
  <verify>Run line count on the file to confirm range. Grep for deprecated patterns to confirm absence.</verify>
  <done>File passes all quality checks: correct line count, no deprecated patterns, no cross-domain content leakage, Cloudflare-specific troubleshooting entries present.</done>
</task>

</tasks>

<verification>
- File follows Phase 2-3 format (Quick Reference, tables, code, anti-patterns, troubleshooting)
- Content boundaries respected per cross-domain assignment table
- All code examples use Astro 5.x API (no Astro 4 patterns)
- Both Astro-generic and Cloudflare-specific errors in troubleshooting
- ~280-320 lines, ~50% tables + ~50% code
</verification>

<success_criteria>
1. `seo-i18n.md` covers SEO meta tags, canonical URLs, OG images, JSON-LD structured data
2. Sitemap and RSS patterns with prerender for Cloudflare
3. i18n routing config with prefixDefaultLocale + redirectToDefaultLocale combo
4. Hreflang component with x-default pattern
5. Translation solution decision matrix (Paraglide recommended)
6. Anti-patterns tagged CRITICAL/HIGH/MEDIUM
7. Troubleshooting table includes Cloudflare-specific errors
8. No content duplication with Phase 2-3 or other Phase 4 files
</success_criteria>

<output>
After completion, create `.planning/phases/04-secondary-domain-references/04-01-SUMMARY.md`
</output>
