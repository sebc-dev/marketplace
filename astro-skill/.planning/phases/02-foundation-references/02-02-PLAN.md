---
phase: 02-foundation-references
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/rendering-modes.md
autonomous: true

must_haves:
  truths:
    - "Claude knows output: 'hybrid' is removed in Astro 5.0 and never suggests it"
    - "Claude can recommend the correct rendering mode for any project type (vitrine, e-commerce, SaaS, blog)"
    - "Claude knows Server Islands require server:defer, a fallback slot with fixed dimensions, and serializable props only"
    - "Claude knows prerender export must be static true/false, not dynamic values"
    - "Claude can generate correct prerender toggle patterns for both static and server output modes"
    - "Claude knows the feature compatibility matrix (sessions, actions, cookies per mode)"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/rendering-modes.md"
      provides: "Rendering mode decision guidance, Server Islands patterns, prerender rules for Cloudflare"
      min_lines: 150
      contains: "## Quick Reference"
  key_links:
    - from: ".claude/skills/astro-cloudflare/references/rendering-modes.md"
      to: "docs/researchs/2 - Rendering Modes.md"
      via: "condensation of research into prescriptive reference"
      pattern: "output.*server|output.*static"
---

<objective>
Write the complete `rendering-modes.md` reference file, replacing the title-only stub from Phase 1.

Purpose: Give Claude correct decision-making knowledge for choosing and configuring rendering modes (SSG/SSR/Server Islands) on Astro 5.17+ with Cloudflare Workers constraints.

Output: One reference file at `.claude/skills/astro-cloudflare/references/rendering-modes.md` (150-250 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation-references/02-CONTEXT.md
@.planning/phases/02-foundation-references/02-RESEARCH.md
@docs/researchs/2 - Rendering Modes.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Read research sources and draft reference file</name>
  <files>.claude/skills/astro-cloudflare/references/rendering-modes.md</files>
  <action>
Read the primary source `docs/researchs/2 - Rendering Modes.md` and the RESEARCH.md content map for rendering-modes.md.

Write `.claude/skills/astro-cloudflare/references/rendering-modes.md` with this structure:

1. **## Quick Reference** (5-10 lines)
   - Numbered imperative rules, one line each
   - Must include: use 'static' or 'server' (never 'hybrid'), prerender must be static true/false, Server Islands need adapter + server:defer, always provide fallback slot with fixed dimensions, use astro:route:setup hook for programmatic prerender control
   - Source: Research 2 section 1

2. **## Output Modes** (~20-25 lines)
   - Comparison table: static vs server
   - Explain: static = default, pages SSG by default, opt-out with prerender: false. Server = SSR by default, opt-in with prerender: true
   - The prerender toggle pattern (export const prerender = true/false)
   - Mention astro:route:setup hook for programmatic control
   - Source: Research 2 section 2

3. **## Decision Matrix** (~25-30 lines)
   - Table: Project Type | Recommended Mode | Config | Reason
   - Cover 8-10 scenarios: static site, blog with comments, client dashboard, e-commerce light, SaaS, landing pages, API-first, site with geo-personalization
   - Cloudflare-aware reasoning (CDN caching, cold start, Workers limits)
   - Source: Research 2 section 2 decision matrix

4. **## Server Islands** (~25-35 lines)
   - What: server:defer directive on Astro components, loads after static shell
   - Pattern: code example showing server:defer with fallback slot (fixed dimensions to prevent CLS)
   - Props: must be serializable, no functions/circular refs, >2048 bytes triggers POST (uncacheable)
   - Cache: set Cache-Control headers in Server Island component
   - URL: Astro.url returns /_server-islands/Component, use Referer header for parent page URL
   - When to use vs alternatives: brief table (Server Island vs client hydration vs full SSR vs partial)
   - Source: Research 2 sections 3 + 6

5. **## Feature Compatibility** (~15-20 lines)
   - Compact matrix: Feature x Mode (SSG, SSR, Server Islands)
   - Cover: Sessions, Actions, Content Layer, Cookies, Middleware, Image optimization, Cache CDN, HTML Streaming
   - Source: Research 2 section 7

6. **## Anti-patterns** (~15-20 lines)
   - Table: Don't | Do | Impact
   - Must include: output: 'hybrid', dynamic prerender value, process.env on Workers, missing fallback slot, prerender true on 404.astro with output: server, Auto Minify with Server Islands, getStaticPaths on prerender: false page
   - Source: Research 2 section 4

7. **## Troubleshooting** (~15-20 lines)
   - Table: Symptom | Cause | Fix
   - Fix must be ONE line
   - Must include: getStaticPaths required, InvalidPrerenderExport, Server Islands timeout/not loading, error 1042/522 on 404, Astro.session undefined, Server Islands not detected in static mode
   - Source: Research 2 section 5

CRITICAL CONSTRAINTS from CONTEXT.md (locked decisions):
- Prescriptive tone: "Use X", "Avoid Y"
- 150-250 lines total
- No cross-references to search_astro_docs
- No package versions
- Tables + code blocks
- Anti-patterns in dedicated section at end
- No confidence tags
- Troubleshooting fix in one line

WHAT TO EXCLUDE:
- Basic HTML rendering concepts
- How CDNs work in general
- astro.config.mjs full template (belongs in project-structure.md)
- wrangler.jsonc config (belongs in cloudflare-platform.md)
- Detailed Workers limits table (belongs in cloudflare-platform.md)
  </action>
  <verify>
1. Count lines: `wc -l .claude/skills/astro-cloudflare/references/rendering-modes.md` -- must be 150-250
2. Check sections: grep for "## Quick Reference", "## Output Modes", "## Decision Matrix", "## Server Islands", "## Feature Compatibility", "## Anti-patterns", "## Troubleshooting"
3. Grep for "hybrid" -- should appear ONLY as "don't use" / anti-pattern context, never as recommended config
4. No MCP references: grep for "search_astro_docs" (must return nothing)
5. No package versions in templates
6. Check key content: grep for "server:defer", "prerender", "fallback", "slot"
  </verify>
  <done>
rendering-modes.md is 150-250 lines with all 7 sections. Decision matrix covers 8+ project scenarios. Server Islands section includes code pattern with fallback. Anti-patterns section warns against hybrid mode. No domain overlap with project-structure.md or cloudflare-platform.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Cross-verify accuracy and finalize</name>
  <files>.claude/skills/astro-cloudflare/references/rendering-modes.md</files>
  <action>
Re-read the written file and verify against RESEARCH.md "State of the Art" table:

1. Verify Astro 5.x rendering changes are correct:
   - output: 'hybrid' removed, replaced by static with opt-out
   - prerender must be static value (not dynamic)
   - Server Islands stable since Astro 5.0
   - ClientRouter (not ViewTransitions) for transitions

2. Verify Server Islands details:
   - server:defer syntax correct
   - fallback slot syntax correct (slot="fallback")
   - Props serialization constraint mentioned
   - Cache-Control headers pattern correct
   - URL via Referer header mentioned

3. Verify no domain overlap:
   - No full astro.config.mjs template (brief config snippets showing output mode are OK)
   - No wrangler.jsonc config
   - No detailed Workers limits (brief mentions like "10ms CPU free tier" in context are OK)
   - No content.config.ts template
   - No project directory trees

4. Verify decision matrix is Cloudflare-aware:
   - References CDN caching for static
   - Mentions cold start for Workers SSR
   - Notes Workers CPU limits impact on complex SSR

5. Fix any issues. Final line count must be 150-250.

6. Commit: `feat(02-02): write rendering-modes.md reference file`
  </action>
  <verify>
1. Re-count lines: 150-250 range confirmed
2. Grep for "ViewTransitions" -- must NOT appear (deprecated name)
3. Grep for "output: 'hybrid'" in non-anti-pattern context -- must NOT appear
4. Server Island code example present with fallback slot
  </verify>
  <done>
rendering-modes.md passes all cross-verification checks: Astro 5.x rendering changes correct, Server Islands details accurate, no domain overlap, Cloudflare-aware decision matrix, committed to git.
  </done>
</task>

</tasks>

<verification>
- File exists and replaces the stub (more than 1 line)
- Line count: 150-250
- All 7 sections present
- Decision matrix covers 8+ scenarios with Cloudflare-specific reasoning
- Server Islands: code example with server:defer and fallback slot
- Feature compatibility matrix present
- No 'hybrid' recommended anywhere
- No package versions, no MCP references
- Prescriptive tone throughout
</verification>

<success_criteria>
Claude reading this file can:
1. Recommend the correct output mode for any Astro/Cloudflare project type
2. Configure prerender toggles correctly (static values only)
3. Implement Server Islands with proper fallback, serializable props, and cache headers
4. Know which features work in which modes (sessions, actions, cookies)
5. Avoid all rendering mode anti-patterns (hybrid, dynamic prerender, missing fallback)
6. Diagnose common rendering-related errors via troubleshooting table
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation-references/02-02-SUMMARY.md`
</output>
