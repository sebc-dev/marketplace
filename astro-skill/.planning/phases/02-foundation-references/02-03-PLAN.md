---
phase: 02-foundation-references
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/cloudflare-platform.md
autonomous: true

must_haves:
  truths:
    - "Claude accesses bindings via Astro.locals.runtime.env, never via cloudflare:workers import or process.env"
    - "Claude knows Workers is the default platform (Pages deprecated April 2025)"
    - "Claude generates correct wrangler.jsonc with nodejs_compat flag and appropriate compatibility_date"
    - "Claude uses .dev.vars for local secrets (not .env) and knows .dev.vars takes precedence"
    - "Claude knows Workers limits (128MB memory, 10ms/30s CPU, 3MB/10MB bundle) and workarounds"
    - "Claude uses node: prefix for all Node.js imports on Workers"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/cloudflare-platform.md"
      provides: "Cloudflare Workers/bindings integration, limits, env vars, wrangler config for Astro"
      min_lines: 150
      contains: "## Quick Reference"
  key_links:
    - from: ".claude/skills/astro-cloudflare/references/cloudflare-platform.md"
      to: "docs/researchs/14 - Cloudflare Integration.md"
      via: "condensation of research into prescriptive reference"
      pattern: "locals\\.runtime\\.env"
---

<objective>
Write the complete `cloudflare-platform.md` reference file, replacing the title-only stub from Phase 1.

Purpose: Give Claude correct knowledge of Cloudflare Workers runtime constraints, binding access patterns, environment variable management, and platform configuration for Astro 5.17+ projects.

Output: One reference file at `.claude/skills/astro-cloudflare/references/cloudflare-platform.md` (150-250 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation-references/02-CONTEXT.md
@.planning/phases/02-foundation-references/02-RESEARCH.md
@docs/researchs/14 - Cloudflare Integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Read research sources and draft reference file</name>
  <files>.claude/skills/astro-cloudflare/references/cloudflare-platform.md</files>
  <action>
Read the primary source `docs/researchs/14 - Cloudflare Integration.md` and the RESEARCH.md content map for cloudflare-platform.md.

Write `.claude/skills/astro-cloudflare/references/cloudflare-platform.md` with this structure:

1. **## Quick Reference** (5-10 lines)
   - Numbered imperative rules, one line each
   - Must include: nodejs_compat required, bindings via locals.runtime.env (not cloudflare:workers), .dev.vars not .env, no Sharp, node: prefix for all Node imports, Workers is default (Pages deprecated), wrangler types before dev
   - Source: Research 14 section 1

2. **## Bindings Access** (~25-30 lines)
   - Pattern for accessing KV/D1/R2 in different contexts:
     - In .astro page: `const { env } = Astro.locals.runtime;`
     - In endpoint: `const { env } = locals.runtime;`
     - In middleware: `const { env } = context.locals.runtime;` (guard with `if (!context.locals.runtime) return next();`)
     - In Actions: `const { env } = context.locals.runtime;`
   - Brief code snippets for each (3-4 lines each, inline)
   - AsyncLocalStorage pattern for deep function access (brief mention with pattern)
   - Source: Research 14 section 5

3. **## Workers Limits** (~15-20 lines)
   - Table: Resource | Free | Paid | Workaround
   - Cover: Bundle size (3MB/10MB), Memory (128MB), CPU time (10ms/30s), Subrequests (50/1000), KV ops/request, Daily requests
   - Source: Research 14 section 6

4. **## Node.js Compatibility** (~15-20 lines)
   - Compact table: Module | Status | Notes
   - Group by: Full support (buffer, crypto, stream, path, url, events, async_hooks, zlib), Partial (tls), Non-functional stubs (child_process, cluster, http2, vm)
   - Compatibility flags table: Flag | Min Date | Purpose
   - Source: Research 14 section 6

5. **## Environment Variables** (~15-20 lines)
   - .dev.vars: for local dev secrets, dotenv syntax, overrides .env completely
   - wrangler secret put: for production secrets
   - vars in wrangler.jsonc: for non-secret config (plaintext!)
   - Key rule: never put secrets in wrangler.jsonc vars
   - Process.env: does NOT work on Workers (use locals.runtime.env or astro:env)
   - Source: Research 14 section 1 + CF env vars docs

6. **## Config Templates** (~40-50 lines)
   Config files that belong in cloudflare-platform.md per CONTEXT.md distribution:
   - **wrangler.jsonc**: Full annotated template for Workers deployment with assets, bindings sections (KV, D1, R2), compatibility flags, environments. No package versions. Copy-pasteable
   - **.dev.vars**: Example showing secret format, comment explaining .env interaction
   - Source: Research 14 section 6

7. **## Anti-patterns** (~15-20 lines)
   - Table: Don't | Do | Impact
   - Must include: import cloudflare:workers directly, non-prefixed Node imports, Sharp image service, global scope binding storage, KV for high-write counters, process.env on Workers, secrets in wrangler.jsonc vars, expensive code in global scope (1s startup timeout)
   - Source: Research 14 section 3

8. **## Troubleshooting** (~15-20 lines)
   - Table: Symptom | Cause | Fix
   - Fix must be ONE line
   - Must include: Cannot bundle node:stream, Worker exceeded size limit, runtime.env undefined (prerendering), _worker.js exposed as asset, bindings undefined in dev (platformProxy), hydration mismatch (Auto Minify), astro:env secrets undefined
   - Source: Research 14 section 4

CRITICAL CONSTRAINTS from CONTEXT.md (locked decisions):
- Prescriptive tone: "Use X", "Avoid Y"
- 150-250 lines total
- No cross-references to search_astro_docs
- No package versions
- Tables + code blocks
- Anti-patterns in dedicated section at end
- No confidence tags
- Troubleshooting fix in one line

WHAT TO EXCLUDE:
- Basic Cloudflare account setup
- How DNS works
- General serverless concepts
- astro.config.mjs template (belongs in project-structure.md)
- Rendering mode decision matrix (belongs in rendering-modes.md)
- Server Islands patterns (belongs in rendering-modes.md)
  </action>
  <verify>
1. Count lines: `wc -l .claude/skills/astro-cloudflare/references/cloudflare-platform.md` -- must be 150-250
2. Check sections: grep for "## Quick Reference", "## Bindings Access", "## Workers Limits", "## Node.js Compatibility", "## Environment Variables", "## Config Templates", "## Anti-patterns", "## Troubleshooting"
3. No MCP references: grep for "search_astro_docs" (must return nothing)
4. No package versions in templates
5. Check key content: grep for "locals.runtime.env", "nodejs_compat", ".dev.vars", "wrangler.jsonc"
6. Verify wrangler.jsonc template is present and annotated
  </verify>
  <done>
cloudflare-platform.md is 150-250 lines with all 8 sections. Bindings access patterns cover all Astro contexts (page, endpoint, middleware, action). wrangler.jsonc template is copy-pasteable with annotated binding sections. Workers limits table present. No domain overlap.
  </done>
</task>

<task type="auto">
  <name>Task 2: Cross-verify accuracy and finalize</name>
  <files>.claude/skills/astro-cloudflare/references/cloudflare-platform.md</files>
  <action>
Re-read the written file and verify against RESEARCH.md "State of the Art" table:

1. Verify Cloudflare platform changes are correct:
   - Workers is default for new projects (Pages deprecated April 2025)
   - wrangler.jsonc preferred over wrangler.toml (since v3.91+)
   - Astro.locals.runtime.env is the 5.x pattern (note: changes in Astro 6)
   - nodejs_compat flag required
   - .dev.vars overrides .env completely

2. Verify bindings access patterns:
   - Guard for prerendering: `if (!context.locals.runtime) return next();`
   - Correct destructuring in each context
   - AsyncLocalStorage pattern mentioned

3. Verify Workers limits are current:
   - Free: 3MB bundle, 10ms CPU, 50 subrequests, 128MB memory
   - Paid: 10MB bundle, 30s CPU (configurable to 5min), 1000 subrequests

4. Verify no domain overlap:
   - No astro.config.mjs full template (brief adapter config mentions are OK)
   - No rendering mode decision matrix
   - No Server Islands patterns
   - No content.config.ts template
   - No project directory trees

5. Verify wrangler.jsonc template:
   - Has $schema for IDE autocompletion
   - Has assets section (Workers deployment)
   - Has compatibility_date and compatibility_flags with nodejs_compat
   - Has binding sections (KV, D1, R2) with placeholder IDs
   - Has environments section example
   - No hardcoded package versions

6. Fix any issues. Final line count must be 150-250.

7. Commit: `feat(02-03): write cloudflare-platform.md reference file`
  </action>
  <verify>
1. Re-count lines: 150-250 range confirmed
2. Grep for "Pages" -- should mention deprecation, not recommend as default
3. Grep for "process.env" -- should appear only in anti-pattern/warning context
4. wrangler.jsonc template has $schema, assets, compatibility_flags
  </verify>
  <done>
cloudflare-platform.md passes all cross-verification checks: Workers as default platform, correct binding access patterns, current limits, no domain overlap, wrangler.jsonc template complete, committed to git.
  </done>
</task>

</tasks>

<verification>
- File exists and replaces the stub (more than 1 line)
- Line count: 150-250
- All 8 sections present
- Bindings access patterns for all 4 Astro contexts (page, endpoint, middleware, action)
- wrangler.jsonc template: annotated, copy-pasteable, with bindings
- .dev.vars example present
- Workers limits table accurate
- Node.js compatibility table present
- No astro.config.mjs template (belongs in project-structure.md)
- No package versions, no MCP references
- Prescriptive tone throughout
</verification>

<success_criteria>
Claude reading this file can:
1. Access Cloudflare bindings (KV/D1/R2) correctly in any Astro context
2. Generate a correct wrangler.jsonc from scratch for Workers deployment
3. Know which Node.js modules work on Workers and which don't
4. Manage environment variables correctly (.dev.vars, wrangler secret, vars)
5. Stay within Workers limits and know workarounds when approaching them
6. Avoid all Cloudflare-specific anti-patterns (global bindings, process.env, Sharp, etc.)
7. Diagnose common Cloudflare integration errors via troubleshooting table
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation-references/02-03-SUMMARY.md`
</output>
