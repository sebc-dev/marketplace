---
phase: 10-reference-file-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/cloudflare-platform.md
  - .claude/skills/astro-cloudflare/references/build-deploy.md
  - .claude/skills/astro-cloudflare/references/security-advanced.md
  - .claude/skills/astro-cloudflare/references/typescript-testing.md
  - .claude/commands/astro/debug.md
autonomous: true

must_haves:
  truths:
    - "cloudflare-platform.md has 4 MCP callouts (Bindings Access, Workers Limits, Node.js Compatibility, Config Templates)"
    - "build-deploy.md has 3 MCP callouts (GitHub Actions CI/CD, CLI Flags Reference, Debugging Workflow)"
    - "security-advanced.md has 1 MCP callout (Secrets Management)"
    - "typescript-testing.md has 2 MCP callouts (env.d.ts Full Pattern, Cloudflare Bindings Test)"
    - "Debug command routing table has 5 Cloudflare symptom entries"
    - "Debug command fallback routes Astro errors to Astro MCP and Cloudflare errors to Cloudflare MCP"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/cloudflare-platform.md"
      contains: "Cloudflare MCP"
    - path: ".claude/skills/astro-cloudflare/references/build-deploy.md"
      contains: "Cloudflare MCP"
    - path: ".claude/skills/astro-cloudflare/references/security-advanced.md"
      contains: "Cloudflare MCP"
    - path: ".claude/skills/astro-cloudflare/references/typescript-testing.md"
      contains: "Cloudflare MCP"
    - path: ".claude/commands/astro/debug.md"
      contains: "mcp__cloudflare__search_cloudflare_documentation"
  key_links:
    - from: "All 4 reference file callouts"
      to: "SKILL.md MCP Integration section"
      via: "Consistent blockquote format and tool name"
      pattern: "Cloudflare MCP.*mcp__cloudflare__search_cloudflare_documentation"
    - from: "Debug command fallback"
      to: "Both MCP tools"
      via: "Dual-MCP routing in If No Match Found section"
      pattern: "search_cloudflare_documentation|search_astro_docs"
---

<objective>
Add MCP Cloudflare callouts to 4 reference files and expand the debug slash command with Cloudflare-specific symptom routing.

Purpose: Reference files currently provide Astro-on-Cloudflare integration patterns but don't tell Claude when to consult Cloudflare docs for exhaustive API details. This plan adds targeted callouts at Cloudflare API boundaries (10 callouts total) and expands the debug command to route Cloudflare runtime/deploy errors to the Cloudflare MCP (5 new symptoms + dual-MCP fallback).

Output: 5 modified Markdown files with MCP callouts and expanded debug routing. SKILL.md is NOT touched (14-line margin reserved for Phase 11).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-reference-file-integration/10-CONTEXT.md
@.planning/phases/10-reference-file-integration/10-RESEARCH.md
@.claude/skills/astro-cloudflare/SKILL.md
@.claude/skills/astro-cloudflare/references/cloudflare-platform.md
@.claude/skills/astro-cloudflare/references/build-deploy.md
@.claude/skills/astro-cloudflare/references/security-advanced.md
@.claude/skills/astro-cloudflare/references/typescript-testing.md
@.claude/commands/astro/debug.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP callouts to 4 reference files</name>
  <files>
    .claude/skills/astro-cloudflare/references/cloudflare-platform.md
    .claude/skills/astro-cloudflare/references/build-deploy.md
    .claude/skills/astro-cloudflare/references/security-advanced.md
    .claude/skills/astro-cloudflare/references/typescript-testing.md
  </files>
  <action>
Add 10 MCP Cloudflare callouts across 4 reference files using the blockquote format from Phase 9. Each callout is 1-2 lines placed AFTER the skill's content in the section, before the next `##` heading. Always insert 1 blank line before the callout blockquote.

**Format (1-line callout):**
```
> **Cloudflare MCP:** For [what CF docs provide], query `mcp__cloudflare__search_cloudflare_documentation` with `"[hybrid query template]"`.
```

**Format (2-line callout, when section covers multiple products):**
```
> **Cloudflare MCP:** `mcp__cloudflare__search_cloudflare_documentation`
> Queries: `"[query 1]"` | `"[query 2]"`
```

**cloudflare-platform.md -- 4 callouts:**

1. **Bindings Access section** (~line 65, after the `> Note: Astro.locals.runtime...` blockquote):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For complete KV/D1/R2 binding method signatures, query `mcp__cloudflare__search_cloudflare_documentation`
   > Queries: `"Workers KV namespace put get delete API"` | `"Cloudflare D1 prepare bind SQL API"`
   ```

2. **Workers Limits section** (~line 77, after the limits table ending with `Upgrade to Paid |`):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For current limits and pricing details, query `mcp__cloudflare__search_cloudflare_documentation` with `"Cloudflare Workers platform limits and pricing"`.
   ```

3. **Node.js Compatibility section** (~line 78-106, after the Node.js API status table):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For per-module compatibility details, query `mcp__cloudflare__search_cloudflare_documentation` with `"Workers nodejs_compat Node.js API support"`.
   ```

4. **Config Templates section** (~line 131-208, after the wrangler.jsonc template code block):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For complete wrangler.jsonc schema reference, query `mcp__cloudflare__search_cloudflare_documentation` with `"Wrangler configuration wrangler.toml schema"`.
   ```

**build-deploy.md -- 3 callouts:**

1. **GitHub Actions CI/CD section** (~line 81-125, after the GitHub Actions workflow code block):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For full wrangler-action options, query `mcp__cloudflare__search_cloudflare_documentation` with `"Cloudflare wrangler-action GitHub Actions deploy"`.
   ```

2. **CLI Flags Reference section** (~line 149-164, after the CLI flags table):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For complete wrangler CLI reference, query `mcp__cloudflare__search_cloudflare_documentation` with `"Wrangler CLI commands reference"`.
   ```

3. **Debugging Workflow section** (~line 165-201, after the debugging workflow content):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For Chrome DevTools integration details, query `mcp__cloudflare__search_cloudflare_documentation` with `"Wrangler dev inspect debugging Workers"`.
   ```

**security-advanced.md -- 1 callout:**

1. **Secrets Management section** (~line 115-145, after the secrets management patterns):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For secrets CLI and API details, query `mcp__cloudflare__search_cloudflare_documentation` with `"Cloudflare Workers secrets wrangler secret put"`.
   ```

**typescript-testing.md -- 2 callouts:**

1. **env.d.ts Full Pattern section** (~line 37-69, after the env.d.ts code block):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For Workers type definitions, query `mcp__cloudflare__search_cloudflare_documentation` with `"Cloudflare Workers types workers-types"`.
   ```

2. **Cloudflare Bindings Test section** (~line 163-204, after the `**Run binding tests separately:**` line):
   Insert blank line then:
   ```
   > **Cloudflare MCP:** For complete vitest-pool-workers options, query `mcp__cloudflare__search_cloudflare_documentation` with `"Cloudflare vitest-pool-workers configuration miniflare"`.
   ```

**IMPORTANT rules:**
- Do NOT place callouts in Quick Reference sections at the top of files
- Do NOT repeat caveats (empty titles, doubled URLs) -- SKILL.md line 119 is the single source
- Do NOT add callouts to Astro-only sections (CSP, Container API, Output Mode, etc.)
- ALL query templates must use the hybrid pattern: product name + specific action (minimum 5 words)
- Read each file FIRST to find the exact insertion point. The line numbers above are approximate -- find the correct section heading and insert after the last content line of that section.
  </action>
  <verify>
Run these grep commands to verify all 10 callouts exist:

```bash
# cloudflare-platform.md: expect 4 matches
grep -c "Cloudflare MCP" .claude/skills/astro-cloudflare/references/cloudflare-platform.md
# build-deploy.md: expect 3 matches
grep -c "Cloudflare MCP" .claude/skills/astro-cloudflare/references/build-deploy.md
# security-advanced.md: expect 1 match
grep -c "Cloudflare MCP" .claude/skills/astro-cloudflare/references/security-advanced.md
# typescript-testing.md: expect 2 matches
grep -c "Cloudflare MCP" .claude/skills/astro-cloudflare/references/typescript-testing.md

# Total across all 4 files: expect 10
grep -rl "Cloudflare MCP" .claude/skills/astro-cloudflare/references/ | wc -l
# Should be 4 (all 4 reference files)

# Verify no callouts in Quick Reference sections (first 20 lines):
head -20 .claude/skills/astro-cloudflare/references/cloudflare-platform.md | grep "Cloudflare MCP"
# Should return nothing

# Verify hybrid query pattern (all queries 5+ words):
grep -oP '`"[^"]*"' .claude/skills/astro-cloudflare/references/cloudflare-platform.md | head -10

# Verify SKILL.md is untouched:
git diff .claude/skills/astro-cloudflare/SKILL.md
# Should show no changes
```
  </verify>
  <done>
10 MCP callouts exist across 4 reference files (4+3+1+2). Each callout uses blockquote format with `> **Cloudflare MCP:**`, placed after section content (not in Quick Reference). All query templates use hybrid pattern (product name + specific action). No caveats repeated. SKILL.md is unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand debug command with Cloudflare symptom routing and dual-MCP fallback</name>
  <files>
    .claude/commands/astro/debug.md
  </files>
  <action>
Modify `.claude/commands/astro/debug.md` in two places:

**Change 1: Add 5 Cloudflare symptom entries to Step 2 routing table (line ~37, after the last existing row `| ViewTransitions errors...`)**

Add these 5 rows to the existing routing table:

```markdown
| `CPU time exceeded` / Worker CPU limit | `cloudflare-platform.md` |
| `KV namespace not bound` / binding errors in production | `cloudflare-platform.md` |
| `compatibility_date` / compat flag errors | `cloudflare-platform.md` |
| `node_compat` / Node.js API not available on Workers | `cloudflare-platform.md` |
| Wrangler deploy fails / `wrangler pages deploy` errors | `build-deploy.md` |
```

These 5 entries cover both runtime errors (CPU limit, KV binding) and wrangler/deploy errors (compatibility_date, node_compat, deploy failures).

**Change 2: Replace "If No Match Found" section (Step 7, currently lines 125-134)**

Replace the entire "### If No Match Found" block with this dual-MCP routing version:

```markdown
### If No Match Found

If no troubleshooting entry, anti-pattern, or Critical Rule matches the symptom:

1. Say so honestly: "This symptom is not covered in the skill's troubleshooting tables."
2. Route to the appropriate MCP based on error domain:
   - **Astro errors** (components, routing, rendering, config, content):
     ```
     mcp__astro_doc__search_astro_docs({ query: "<relevant search terms>" })
     ```
   - **Cloudflare errors** (Workers runtime, KV/D1/R2, wrangler, deploy):
     ```
     mcp__cloudflare__search_cloudflare_documentation({ query: "<product> <specific error>" })
     ```
3. Suggest the user share more context (full error stack trace, config files, reproduction steps).
```

This preserves the existing Astro MCP fallback AND adds the Cloudflare MCP as a second routing option. The key change is going from "always suggest Astro MCP" to "route based on error domain."

**IMPORTANT:**
- Keep the frontmatter (lines 1-10) unchanged
- Keep Steps 1, 3-6, 8, and Important Constraints unchanged
- Only modify Step 2 (add rows to table) and the "If No Match Found" subsection under Step 7
  </action>
  <verify>
```bash
# Verify 5 new symptom entries exist:
grep -c "CPU time exceeded\|KV namespace not bound\|compatibility_date\|node_compat\|wrangler pages deploy" .claude/commands/astro/debug.md
# Should return 5

# Verify total routing table rows (12 original + 5 new = 17):
grep -c "^|.*|.*|$" .claude/commands/astro/debug.md
# Should be at least 17 (plus header row)

# Verify both MCPs appear in fallback:
grep "search_astro_docs" .claude/commands/astro/debug.md
# Should return at least 1 match
grep "search_cloudflare_documentation" .claude/commands/astro/debug.md
# Should return at least 1 match

# Verify dual routing keywords:
grep "Astro errors\|Cloudflare errors" .claude/commands/astro/debug.md
# Should return 2 matches

# Verify frontmatter preserved:
head -10 .claude/commands/astro/debug.md | grep "disable-model-invocation: true"
# Should match
```
  </verify>
  <done>
Debug command routing table has 17 symptom entries (12 original + 5 Cloudflare). The "If No Match Found" fallback routes Astro errors to Astro MCP and Cloudflare errors to Cloudflare MCP. Both `search_astro_docs` and `search_cloudflare_documentation` appear in the fallback. Frontmatter and all other steps are unchanged.
  </done>
</task>

</tasks>

<verification>
Run these comprehensive checks after both tasks complete:

1. **Callout count verification:**
   ```bash
   echo "cloudflare-platform: $(grep -c 'Cloudflare MCP' .claude/skills/astro-cloudflare/references/cloudflare-platform.md)"
   echo "build-deploy: $(grep -c 'Cloudflare MCP' .claude/skills/astro-cloudflare/references/build-deploy.md)"
   echo "security-advanced: $(grep -c 'Cloudflare MCP' .claude/skills/astro-cloudflare/references/security-advanced.md)"
   echo "typescript-testing: $(grep -c 'Cloudflare MCP' .claude/skills/astro-cloudflare/references/typescript-testing.md)"
   ```
   Expected: 4, 3, 1, 2

2. **Debug symptom count:**
   ```bash
   grep -c "^|" .claude/commands/astro/debug.md
   ```
   Expected: 18+ (17 data rows + 1 header + 1 separator)

3. **Dual-MCP in debug fallback:**
   ```bash
   grep -c "mcp__" .claude/commands/astro/debug.md
   ```
   Expected: 2 (one astro, one cloudflare)

4. **SKILL.md untouched:**
   ```bash
   git diff --stat .claude/skills/astro-cloudflare/SKILL.md
   ```
   Expected: no output (no changes)

5. **No callouts in Quick Reference sections (spot check):**
   ```bash
   head -15 .claude/skills/astro-cloudflare/references/cloudflare-platform.md | grep "Cloudflare MCP" && echo "FAIL: callout in Quick Reference" || echo "PASS"
   head -15 .claude/skills/astro-cloudflare/references/build-deploy.md | grep "Cloudflare MCP" && echo "FAIL: callout in Quick Reference" || echo "PASS"
   ```
   Expected: PASS, PASS

6. **Grep heading navigation still works (Phase 11 will fully validate):**
   ```bash
   grep -n "## Bindings Access" .claude/skills/astro-cloudflare/references/cloudflare-platform.md
   grep -n "## Workers Limits" .claude/skills/astro-cloudflare/references/cloudflare-platform.md
   ```
   Expected: both headings found (line numbers may shift, but headings must exist)
</verification>

<success_criteria>
- 10 MCP callouts across 4 reference files using consistent `> **Cloudflare MCP:**` blockquote format
- 5 Cloudflare symptom entries in debug routing table (CPU limit, KV binding, compatibility_date, node_compat, wrangler deploy)
- Debug fallback routes to Astro MCP for Astro errors AND Cloudflare MCP for Cloudflare errors
- SKILL.md has zero changes
- All existing content in reference files and debug command is preserved (callouts are additive)
</success_criteria>

<output>
After completion, create `.planning/phases/10-reference-file-integration/10-01-SUMMARY.md`
</output>
