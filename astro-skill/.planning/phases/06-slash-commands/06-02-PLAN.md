---
phase: 06-slash-commands
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/astro/audit.md
autonomous: true

must_haves:
  truths:
    - "Invoking /project:astro:audit runs a comprehensive check of the current Astro/Cloudflare project against skill best practices"
    - "Audit command pre-reads project config files using dynamic context injection (!`command` syntax)"
    - "Audit command checks all 10 Critical Rules from SKILL.md"
    - "Audit command reads Anti-patterns sections from reference files dynamically (not hardcoded)"
    - "Audit report categorizes findings by severity (CRITICAL / HIGH / MEDIUM)"
    - "Audit command does not auto-invoke (has disable-model-invocation: true)"
  artifacts:
    - path: ".claude/commands/astro/audit.md"
      provides: "Audit command for checking Astro/Cloudflare project configuration"
      contains: "disable-model-invocation: true"
  key_links:
    - from: "audit.md dynamic context injection"
      to: "astro.config.mjs, package.json, wrangler.jsonc, tsconfig.json"
      via: "!`cat file` syntax in command body"
      pattern: "!`cat"
    - from: "audit.md Critical Rules check"
      to: "SKILL.md Critical Rules"
      via: "Read SKILL.md for the 10 breaking change rules"
      pattern: "Critical Rules"
    - from: "audit.md Anti-patterns check"
      to: "references/*.md Anti-patterns sections"
      via: "grep -n Anti-patterns in each reference file"
      pattern: "Anti-patterns"
---

<objective>
Create the audit slash command for the astro-cloudflare skill.

Purpose: The audit command is the most complex of the three commands because it uses dynamic context injection to pre-read project files and checks against all 11 reference files' anti-patterns. It deserves its own plan for quality.
Output: One command file at `.claude/commands/astro/audit.md`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research
@.planning/phases/06-slash-commands/06-RESEARCH.md

# Existing skill (audit references all these)
@.claude/skills/astro-cloudflare/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit command</name>
  <files>.claude/commands/astro/audit.md</files>
  <action>
Create `.claude/commands/astro/audit.md` (directory should already exist from Plan 01, but create if needed).

**Frontmatter:**
```yaml
---
description: Audit an existing Astro 5.x / Cloudflare Workers project against skill best practices and anti-patterns
disable-model-invocation: true
allowed-tools:
  - Read
  - Grep
  - Glob
  - Bash
---
```

Note: No `argument-hint` needed -- audit operates on the current project, no arguments required.

**Body structure:**

**Section 1: Dynamic Context Injection (pre-reads project files)**

Use `!`command`` syntax to inject current project state before Claude sees the prompt:

```markdown
## Current Project State

### Astro Config
!`cat astro.config.mjs 2>/dev/null || cat astro.config.ts 2>/dev/null || echo "NO_ASTRO_CONFIG"`

### Package.json
!`cat package.json 2>/dev/null || echo "NO_PACKAGE_JSON"`

### Wrangler Config
!`cat wrangler.jsonc 2>/dev/null || cat wrangler.toml 2>/dev/null || echo "NO_WRANGLER_CONFIG"`

### TypeScript Config
!`cat tsconfig.json 2>/dev/null || echo "NO_TSCONFIG"`

### Content Config
!`cat src/content.config.ts 2>/dev/null || echo "NO_CONTENT_CONFIG"`

### Content Config (wrong location check)
!`ls src/content/config.ts 2>/dev/null || echo "NOT_AT_WRONG_LOCATION"`

### Environment Files
!`ls .dev.vars .env 2>/dev/null || echo "NO_ENV_FILES"`

### Source Structure
!`find src -type f -name "*.astro" -o -name "*.ts" -o -name "*.tsx" 2>/dev/null | head -30 || echo "NO_SRC"`
```

**Section 2: Audit Instructions**

Instruct Claude to perform the audit in this order:

**2a. Critical Rules Check (CRITICAL severity):**
Check the pre-loaded project files against all 10 Critical Rules from SKILL.md. For each rule, check:

1. Content config at `src/content.config.ts` not `src/content/config.ts`
2. No `entry.slug` usage (grep `src/` for `.slug`)
3. `render()` imported from `astro:content`, not called as method
4. `loader: glob()` or `loader: file()` syntax, not `type: 'content'` or `type: 'data'`
5. `ClientRouter` used, not `ViewTransitions`
6. `Astro.locals.runtime.env` used, not `process.env` for runtime vars
7. `imageService: 'compile'` in adapter config or no Sharp dependency in package.json
8. `output: 'static'` or `output: 'server'`, not `output: 'hybrid'`
9. `decodeURIComponent(Astro.params.*)` if dynamic routes exist
10. `import { z } from 'astro/zod'` not `from 'zod'` directly

For each violated rule, report:
- Rule number and description
- Where found (file + line)
- Fix (the correct pattern)

**2b. Cloudflare Compatibility Check (CRITICAL severity):**
Read `.claude/skills/astro-cloudflare/references/cloudflare-platform.md` Anti-patterns section. Check:
- `process.env` usage anywhere in `src/` (should be `Astro.locals.runtime.env`)
- Sharp in dependencies
- Missing `nodejs_compat` in compatibility_flags (wrangler config)
- Missing `nodejs_compat_populate_process_env` flag
- `.env` file exists alongside `.dev.vars` (conflict)

**2c. Config Correctness Checks (HIGH severity):**
Read anti-patterns from these reference files (use grep to find ## Anti-patterns section in each):
- `.claude/skills/astro-cloudflare/references/project-structure.md`
- `.claude/skills/astro-cloudflare/references/rendering-modes.md`
- `.claude/skills/astro-cloudflare/references/typescript-testing.md`
- `.claude/skills/astro-cloudflare/references/build-deploy.md`

Check:
- `platformProxy: { enabled: true }` in astro.config (if adapter present)
- tsconfig extends `astro/tsconfigs/strict` or `astro/tsconfigs/strictest`
- package.json has `wrangler types` in dev/build scripts
- `.assetsignore` exists (if static assets are large)
- Correct adapter import (`@astrojs/cloudflare`)

**2d. Best Practices Checks (MEDIUM severity):**
Read anti-patterns from remaining reference files:
- `.claude/skills/astro-cloudflare/references/components-islands.md`
- `.claude/skills/astro-cloudflare/references/routing-navigation.md`
- `.claude/skills/astro-cloudflare/references/data-content.md`
- `.claude/skills/astro-cloudflare/references/styling-performance.md`
- `.claude/skills/astro-cloudflare/references/seo-i18n.md`
- `.claude/skills/astro-cloudflare/references/security-advanced.md`

Check for common issues:
- `client:load` overuse (should prefer `client:visible` or `client:idle`)
- Missing `site` in astro.config (needed for sitemap/canonical URLs)
- `ViewTransitions` import instead of `ClientRouter`
- Inline styles that should be scoped
- Missing `alt` on Image components

**Section 3: Report Format**

Instruct Claude to output the audit report in this structure:

```markdown
# Astro/Cloudflare Audit Report

## Summary
- Project: [name from package.json]
- Rendering mode: [detected from astro.config]
- Adapter: [detected]
- Issues found: X CRITICAL, Y HIGH, Z MEDIUM

## CRITICAL Issues
[If any -- these break the build or runtime]

### [Issue title]
- **File:** path/to/file:line
- **Problem:** [what's wrong]
- **Fix:** [the correct pattern]
- **Reference:** [link to reference file section]

## HIGH Issues
[If any -- these cause bugs or poor DX]

## MEDIUM Issues
[If any -- best practice improvements]

## Passed Checks
[List of checks that passed -- gives confidence]

## Recommendations
[Ordered list of fixes, most critical first]
```

**Section 4: Post-audit**
- Offer to fix CRITICAL issues automatically (with user confirmation per fix)
- Suggest reading specific reference file sections for HIGH/MEDIUM issues
- If no issues found, confirm the project follows skill best practices

**Critical constraints:**
- Read anti-patterns from reference files dynamically, do NOT hardcode the anti-pattern content in this command
- Use grep to find Anti-patterns sections: `grep -n "## Anti-patterns" .claude/skills/astro-cloudflare/references/{file}`
- Check ALL files listed in pre-loaded context even if some are missing (report "NOT FOUND" as its own finding if critical files like astro.config are missing)
- The audit must work on both SSG and SSR projects
  </action>
  <verify>
- File exists at `.claude/commands/astro/audit.md`
- File has valid YAML frontmatter with `disable-model-invocation: true`
- File contains `!`cat` dynamic context injection for at least: astro.config, package.json, wrangler config, tsconfig.json
- File references SKILL.md Critical Rules (all 10)
- File references anti-patterns sections from reference files via grep
- File structures output as CRITICAL / HIGH / MEDIUM severity
- File instructs Claude to read anti-patterns dynamically from references (grep), not hardcode them
- No `argument-hint` in frontmatter (audit needs no arguments)
  </verify>
  <done>Audit command file exists with dynamic context injection, comprehensive checks against all 10 Critical Rules and all 11 reference files' anti-patterns, severity-categorized reporting, and guided fix suggestions</done>
</task>

</tasks>

<verification>
1. `ls .claude/commands/astro/audit.md` -- file exists
2. `grep -c "disable-model-invocation: true" .claude/commands/astro/audit.md` -- returns 1
3. `grep -c '!.cat' .claude/commands/astro/audit.md` -- returns >= 4 (astro.config, package.json, wrangler, tsconfig)
4. `grep -c "Anti-patterns" .claude/commands/astro/audit.md` -- returns >= 3
5. `grep -c "Critical Rules" .claude/commands/astro/audit.md` -- returns >= 1
6. `grep -c "CRITICAL\|HIGH\|MEDIUM" .claude/commands/astro/audit.md` -- returns >= 3
</verification>

<success_criteria>
- Audit command pre-reads project files via dynamic context injection
- Audit checks all 10 Critical Rules at CRITICAL severity
- Audit reads anti-patterns from all 11 reference files dynamically (not hardcoded)
- Audit report uses CRITICAL / HIGH / MEDIUM severity levels
- Audit offers to fix CRITICAL issues with user confirmation
- Command uses `disable-model-invocation: true`
</success_criteria>

<output>
After completion, create `.planning/phases/06-slash-commands/06-02-SUMMARY.md`
</output>
