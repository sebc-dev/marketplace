---
phase: 06-slash-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/astro/scaffold.md
  - .claude/commands/astro/debug.md
autonomous: true

must_haves:
  truths:
    - "Invoking /project:astro:scaffold [name] starts a guided Astro/Cloudflare project creation workflow"
    - "Scaffold command asks rendering mode, Cloudflare bindings, and Tailwind preference before generating files"
    - "Scaffold command reads config templates from references/project-structure.md and references/cloudflare-platform.md rather than inlining them"
    - "Invoking /project:astro:debug [symptom] routes the symptom to the correct reference file via the Quick Troubleshooting Index"
    - "Debug command reads Troubleshooting tables from identified reference files and suggests fixes"
    - "Neither command auto-invokes (both have disable-model-invocation: true)"
  artifacts:
    - path: ".claude/commands/astro/scaffold.md"
      provides: "Scaffolding command for new Astro/Cloudflare projects"
      contains: "disable-model-invocation: true"
    - path: ".claude/commands/astro/debug.md"
      provides: "Debug/troubleshoot command for Astro/Cloudflare errors"
      contains: "disable-model-invocation: true"
  key_links:
    - from: "scaffold.md"
      to: "references/project-structure.md, references/cloudflare-platform.md, references/rendering-modes.md"
      via: "Read tool to extract config templates and file organization"
      pattern: "astro-cloudflare/references/"
    - from: "debug.md"
      to: "SKILL.md Quick Troubleshooting Index"
      via: "Symptom-to-reference routing table"
      pattern: "Quick Troubleshooting Index"
    - from: "debug.md"
      to: "references/*.md Troubleshooting sections"
      via: "grep -n Troubleshooting to find relevant section"
      pattern: "Troubleshooting"
---

<objective>
Create the scaffold and debug slash commands for the astro-cloudflare skill.

Purpose: These two commands enable explicit user-triggered workflows: creating new projects with correct defaults (scaffold) and diagnosing Astro/Cloudflare errors using the skill's troubleshooting knowledge (debug).
Output: Two command files at `.claude/commands/astro/scaffold.md` and `.claude/commands/astro/debug.md`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research
@.planning/phases/06-slash-commands/06-RESEARCH.md

# Existing skill (commands reference these files)
@.claude/skills/astro-cloudflare/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scaffold command</name>
  <files>.claude/commands/astro/scaffold.md</files>
  <action>
Create the directory `.claude/commands/astro/` if it does not exist, then create `scaffold.md`.

**Frontmatter:**
```yaml
---
description: Create a new Astro 5.x project on Cloudflare Workers with recommended structure, configs, and best practices
disable-model-invocation: true
argument-hint: "[project-name]"
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
---
```

**Body structure (the command prompt Claude follows when invoked):**

1. **Project name:** Use `$ARGUMENTS` as the project directory name. If empty, ask the user for a name.

2. **Configuration questions (ask all at once, not sequentially):**
   - Rendering mode: SSG (default), SSG + SSR pages, Full SSR
   - Cloudflare bindings: None (default), KV, D1, R2, or combination
   - Tailwind CSS: Yes/No (default Yes)
   - Package manager: npm (default), pnpm, yarn

3. **Read config templates from skill reference files:**
   - Read `.claude/skills/astro-cloudflare/references/project-structure.md` -- grep for "## File Organization" for directory structure, then grep for the appropriate "### astro.config.mjs" variant based on rendering mode choice, plus "### tsconfig.json", "### src/env.d.ts", "### src/content.config.ts"
   - Read `.claude/skills/astro-cloudflare/references/cloudflare-platform.md` -- grep for "### wrangler.jsonc" for the wrangler template, "### .dev.vars" for env vars template
   - If Tailwind selected: Read `.claude/skills/astro-cloudflare/references/styling-performance.md` -- grep for "## Tailwind v4 Setup"
   - If bindings selected: Read `.claude/skills/astro-cloudflare/references/cloudflare-platform.md` -- grep for "## Bindings Access" for binding patterns

4. **Generate project files:**
   - Create project directory
   - Create file structure per project-structure.md File Organization section (adapt simple vs complex based on project scope)
   - Write config files using templates from reference files (adapting for user choices)
   - Create `package.json` with correct scripts from the reference (including `wrangler types` in dev/build scripts)
   - Create `.gitignore` (include `.wrangler/`, `.dev.vars`, `dist/`, `node_modules/`)
   - If bindings selected: add binding entries to wrangler.jsonc and type stubs to env.d.ts
   - Create `.vscode/extensions.json` and `.vscode/settings.json` if VS Code config exists in `build-deploy.md`

5. **Post-creation steps:**
   - Run the selected package manager install command
   - Run `npx wrangler types` to generate Cloudflare binding types (if bindings configured)
   - Print a summary of created files and next steps

**Critical constraints to embed in the command:**
- Apply ALL 10 Critical Rules from SKILL.md (especially: `content.config.ts` at `src/` not `src/content/`, `output: 'static'` or `output: 'server'` never `hybrid`, `imageService: 'compile'` not Sharp)
- NEVER inline config patterns from memory -- always read them from the reference files
- Use Workers (not Pages) as the deployment target per decision [02-03]
  </action>
  <verify>
- File exists at `.claude/commands/astro/scaffold.md`
- File has valid YAML frontmatter with `disable-model-invocation: true`
- File references at least `project-structure.md`, `cloudflare-platform.md`, `rendering-modes.md` via full paths
- File contains `$ARGUMENTS` for project name
- File instructs Claude to read config templates from reference files (not inline them)
- File mentions all 10 Critical Rules or references SKILL.md Critical Rules section
  </verify>
  <done>Scaffold command file exists with complete workflow instructions that read from reference files, ask user preferences, and generate a correctly-configured Astro/Cloudflare project</done>
</task>

<task type="auto">
  <name>Task 2: Create debug command</name>
  <files>.claude/commands/astro/debug.md</files>
  <action>
Create `.claude/commands/astro/debug.md`.

**Frontmatter:**
```yaml
---
description: Diagnose common Astro 5.x / Cloudflare Workers errors using skill troubleshooting tables
disable-model-invocation: true
argument-hint: "[error message or symptom description]"
allowed-tools:
  - Read
  - Grep
  - Glob
  - Bash
---
```

**Body structure (the command prompt Claude follows when invoked):**

1. **Accept symptom:** Use `$ARGUMENTS` as the error/symptom description. If empty, ask the user to describe the error or paste the error message.

2. **Route to reference files using Quick Troubleshooting Index:**
   Embed the routing table directly (this is small enough to inline and critical for fast routing):

   | Symptom Pattern | Reference File |
   |----------------|----------------|
   | `Cannot find module` / import errors | `typescript-testing.md` |
   | Build fails on Cloudflare | `build-deploy.md` |
   | `process.env` undefined | `cloudflare-platform.md` |
   | Image processing / Sharp errors | `styling-performance.md` |
   | Hydration mismatch | `components-islands.md` |
   | Content collection errors | `data-content.md` |
   | 404 on dynamic routes | `routing-navigation.md` |
   | CSP / security header issues | `security-advanced.md` |
   | Sitemap / SEO missing | `seo-i18n.md` |
   | Server Island not rendering | `components-islands.md` + `rendering-modes.md` |
   | Binding not available in dev | `cloudflare-platform.md` |
   | ViewTransitions errors | `routing-navigation.md` |

3. **Read troubleshooting section from matched reference file(s):**
   - Use `grep -n "## Troubleshooting" .claude/skills/astro-cloudflare/references/{matched-file}` to find the section
   - Read the Troubleshooting table (Symptom / Cause / Fix columns)
   - Match the user's symptom to the closest table entry

4. **Check anti-patterns if no direct troubleshooting match:**
   - Use `grep -n "## Anti-patterns" .claude/skills/astro-cloudflare/references/{matched-file}` to find the anti-patterns section
   - Check if user's error aligns with a known anti-pattern (Don't / Do / Severity columns)

5. **Check Critical Rules:**
   - Read SKILL.md Critical Rules section
   - Check if the symptom matches any of the 10 breaking change violations

6. **Read relevant project files for confirmation:**
   - If error involves config: read `astro.config.mjs`, `wrangler.jsonc`, `tsconfig.json`
   - If error involves imports: read the failing file
   - If error involves content: read `src/content.config.ts`

7. **Present diagnosis:**
   - **Symptom:** (user's description)
   - **Likely Cause:** (from troubleshooting table or anti-patterns)
   - **Fix:** (from troubleshooting table, with code snippet if available)
   - **Reference:** (link to the reference file section for full context)
   - **Diagnostic commands:** If relevant, suggest commands from `build-deploy.md` Debugging Workflow (wrangler tail, wrangler dev --inspect, etc.)

8. **Offer to apply fix:** Ask the user if they want you to apply the suggested fix. Do NOT auto-apply.

**Critical constraints:**
- Always read from reference files, never diagnose from memory alone
- If no match found in any troubleshooting table, say so honestly and suggest using `mcp__astro_doc__search_astro_docs` for broader search
- Route to multiple reference files if symptom spans domains (e.g., Server Island issues touch both components-islands.md and rendering-modes.md)
  </action>
  <verify>
- File exists at `.claude/commands/astro/debug.md`
- File has valid YAML frontmatter with `disable-model-invocation: true`
- File contains the 12-row symptom routing table
- File contains `$ARGUMENTS` for error/symptom input
- File instructs Claude to read Troubleshooting sections from reference files via grep
- File instructs Claude to check Anti-patterns as fallback
- File references SKILL.md Critical Rules
- File instructs to offer fix application with user confirmation (no auto-apply)
  </verify>
  <done>Debug command file exists with complete diagnostic workflow: symptom routing, troubleshooting table lookup, anti-pattern fallback, Critical Rules check, project file reading, and fix suggestion with user confirmation</done>
</task>

</tasks>

<verification>
1. `ls .claude/commands/astro/scaffold.md .claude/commands/astro/debug.md` -- both files exist
2. `grep -c "disable-model-invocation: true" .claude/commands/astro/scaffold.md .claude/commands/astro/debug.md` -- both return 1
3. `grep -c "ARGUMENTS" .claude/commands/astro/scaffold.md .claude/commands/astro/debug.md` -- both return >= 1
4. `grep -c "astro-cloudflare/references/" .claude/commands/astro/scaffold.md` -- returns >= 3 (project-structure, cloudflare-platform, rendering-modes)
5. `grep -c "Troubleshooting" .claude/commands/astro/debug.md` -- returns >= 3
</verification>

<success_criteria>
- Scaffold command creates guided project creation workflow reading from reference files
- Debug command routes symptoms to reference files and presents structured diagnoses
- Both commands use `disable-model-invocation: true`
- Neither command inlines content that belongs in reference files
</success_criteria>

<output>
After completion, create `.planning/phases/06-slash-commands/06-01-SUMMARY.md`
</output>
