---
phase: 03-core-domain-references
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/styling-performance.md
autonomous: true

must_haves:
  truths:
    - "Claude uses @tailwindcss/vite (not deprecated @astrojs/tailwind) for Tailwind v4"
    - "Claude uses imageService:'compile' on Cloudflare (not Sharp which is incompatible with Workers)"
    - "Claude adds @reference in style blocks for @apply in Tailwind v4"
    - "Claude sets Cache-Control:immutable on /_astro/* assets in _headers file"
    - "Claude uses priority attribute on LCP images with layout='full-width'"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/styling-performance.md"
      provides: "Styling and Performance reference"
      min_lines: 250
      contains: "Quick Reference"
  key_links:
    - from: "styling-performance.md"
      to: "Phase 2 cloudflare-platform.md"
      via: "cross-reference for Workers limits and caching"
      pattern: "cloudflare-platform"
---

<objective>
Write the `styling-performance.md` reference file covering scoped styles, Tailwind v4, image optimization without Sharp, caching strategies, Core Web Vitals, and prefetch on Cloudflare.

Purpose: Claude needs to generate correct styling and performance optimization code for Astro 5.x on Cloudflare -- specifically Tailwind v4 migration, image service selection (Sharp incompatible with Workers), and Cloudflare-specific caching patterns.
Output: `references/styling-performance.md` (~280-300 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-domain-references/03-RESEARCH.md
@.planning/phases/03-core-domain-references/03-CONTEXT.md

# Phase 2 reference files -- match format and style
@.claude/skills/astro-cloudflare/references/project-structure.md
@.claude/skills/astro-cloudflare/references/rendering-modes.md
@.claude/skills/astro-cloudflare/references/cloudflare-platform.md

# Primary research sources
@docs/researchs/7 - Styling.md
@docs/researchs/8 - Performance.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write styling-performance.md reference file</name>
  <files>.claude/skills/astro-cloudflare/references/styling-performance.md</files>
  <action>
Write `styling-performance.md` following the exact format established by Phase 2 reference files. Target ~280-300 lines. Content ratio: ~50% tables + ~50% code examples, minimal narrative prose.

**STRUCTURE (in order):**

1. **Title + subtitle** (1 line): `# Styling and Performance` + subtitle mentioning scoped styles, Tailwind v4, image optimization, caching, Core Web Vitals on Cloudflare.

2. **Quick Reference** (~14 numbered imperative rules):
   Draw from Research 7 section 1 + Research 8 section 1. Must include:
   - Use `@tailwindcss/vite` for Tailwind v4 -- `@astrojs/tailwind` is deprecated
   - Add `@reference "../styles/global.css"` in `<style>` blocks to use `@apply` in Tailwind v4
   - Import global CSS in Layout first -- guarantees lowest cascade precedence
   - Pass `class` prop AND `{...rest}` to child components for scoped style propagation
   - Use `:global(.selector)` to mix scoped and global styles -- prefer over `is:global` for precision
   - Avoid CSS-in-JS runtime (styled-components/Emotion) for SSR on Cloudflare -- causes FOUC and build errors
   - Use `imageService: 'compile'` for Cloudflare -- Sharp incompatible with Workers runtime
   - Use `priority` attribute on the single LCP image per page -- enables eager loading + fetchpriority=high (Astro 5.10+)
   - Use `layout="constrained"` as default image layout -- responsive shrink without upscale
   - Configure `/_astro/*` with `Cache-Control: public, max-age=31536000, immutable` in `public/_headers`
   - Use `build.inlineStylesheets: 'auto'` (default) -- inline <4kB, external otherwise
   - Rename `--astro-code-color-text` to `--astro-code-foreground` -- breaking change Astro 5.0
   - Disable Auto Minify in Cloudflare dashboard -- breaks Server Islands and causes hydration mismatches
   - Configure `prefetch.defaultStrategy: 'hover'` -- balance UX and bandwidth

3. **Image Service Selection Matrix** (~5 rows table):
   Format: `| Scenario | Service | Reason |`
   Draw from Research 8 section 2b. Cover: hybrid/static on Cloudflare (compile), SSR with runtime optimization (cloudflare service), no optimization needed (passthrough), Sharp (never on Workers -- requires native bindings), dev local vs production (Sharp local, compile/cloudflare prod).

4. **Image Component Patterns** (~25 lines code):
   Show 3 patterns:
   - Hero image with `priority`, `layout="full-width"`, `fit="cover"`
   - Responsive image with `layout="constrained"` (default)
   - Remote image with manual preload using `getImage()` + `<link rel="preload">`
   Draw from Research 8 section 6 patterns.

5. **CSS Approach Selection Matrix** (~7 rows table):
   Format: `| Scenario | Approach | Reason |`
   Draw from Research 7 section 2. Cover: default styling (Astro scoped), utility-first (Tailwind v4), dynamic styles in React island (CSS Modules), type-safe zero-runtime (Vanilla Extract), global reset/typography (import in Layout), dark mode code blocks (Shiki themes), variables from frontmatter (define:vars).

6. **Tailwind v4 Setup** (~20 lines code):
   Show:
   - `astro.config.mjs` with `@tailwindcss/vite` plugin
   - `src/styles/global.css` with `@import "tailwindcss"` and `@theme` block
   - Component using `@reference` for `@apply`
   Draw from Research 7 Pattern 2.

7. **Caching Strategy Table** (~7 rows table):
   Format: `| Asset Type | Cache-Control | Where to Configure |`
   Draw from Research 8 section 4. Cover: JS/CSS hashed (/_astro/*), HTML pages, hashed images, non-hashed images, fonts, API SSR responses, Server Islands.
   Note: `_headers` file does NOT apply to SSR responses -- set headers in code.

8. **_headers File Pattern** (~15 lines):
   Show complete `public/_headers` with:
   - `/_astro/*` immutable
   - HTML pages must-revalidate
   - Fonts immutable
   - Non-hashed images stale-while-revalidate
   - Security headers (X-Content-Type-Options, X-Frame-Options)
   Draw from Research 8 section 6 Pattern 3.

9. **Prefetch Strategy** (~8 rows brief table):
   Format: `| Link Type | Strategy | Why |`
   Cover: main navigation (hover), static frequent pages (viewport), heavy SSR pages (tap), API endpoints (false/disabled), with ClientRouter (override prefetchAll:false).
   Draw from Research 8 section 2d.

10. **Anti-patterns** table (~12 rows):
    Format: `| Don't | Do | Severity |`
    Must include:
    - CRITICAL: Sharp image service on Cloudflare SSR -> `imageService: 'compile'`
    - CRITICAL: `styled-components` for SSR Cloudflare -> CSS Modules, Tailwind, Panda CSS
    - HIGH: `@astrojs/tailwind` for Tailwind v4 -> `@tailwindcss/vite`
    - HIGH: `@apply` without `@reference` in Tailwind v4 -> add `@reference` directive
    - HIGH: Fonts in `public/` -> `src/assets/fonts/` to avoid build duplication
    - HIGH: `--astro-code-color-text` (old Shiki var name) -> `--astro-code-foreground`
    - HIGH: Images without `priority` on LCP element -> add `priority` on hero image
    - MEDIUM: `<link rel="stylesheet">` for local CSS -> import in frontmatter for bundling
    - MEDIUM: `is:global` for single selector -> `:global(.selector)` for precision
    - MEDIUM: `client:only` components with Tailwind -> safelist classes or use elsewhere to prevent purge
    - MEDIUM: Custom Cache-Control on `/_astro/*` -> rely on Astro fingerprinting + immutable
    - MEDIUM: `prefetchAll: true` + `defaultStrategy: 'load'` -> bandwidth waste, Workers quota burn

11. **Troubleshooting** table (~10 rows):
    Format: `| Symptom | Cause | Fix |`
    Must include Cloudflare-specific:
    - Scoped styles not affecting child -> `data-astro-cid-*` not propagated -> pass `{...rest}`
    - `@apply` not resolving Tailwind classes -> style blocks isolated in v4 -> add `@reference`
    - FOUC (Flash of Unstyled Content) -> CSS-in-JS runtime in SSR -> migrate to zero-runtime
    - `/_image` returns 404 on Workers -> imageService config wrong -> use `compile`, check `.assetsignore`
    - Hydration mismatch errors -> Auto Minify enabled -> disable in Cloudflare dashboard
    - CSS assets stale after deploy -> Cache Rules custom on CF -> use only `_headers` file
    - Tailwind classes missing in prod -> `client:only` purges undetected classes -> safelist
    - Code highlighting without colors -> Shiki v4->v5 variable rename -> use `--astro-code-foreground`
    - Grid/flex children broken with islands -> `<astro-island>` wrapper -> target `> astro-island > .child`
    - Image optimization fails in SSR -> Sharp incompatible Workers -> expected with `compile` (build-only)

**CONTENT BOUNDARIES (from cross-domain assignment):**
- DO include: scoped styles, Tailwind v4, image optimization (Image/Picture/getImage), image services, caching, _headers, prefetch, Core Web Vitals, Shiki variables, CSS approach selection
- DO NOT include: hydration directives (belongs in components-islands.md)
- DO NOT include: Server Islands implementation (belongs in components-islands.md)
- DO NOT include: Content Layer config (belongs in data-content.md)
- DO NOT include: routing/middleware (belongs in routing-navigation.md)

**LANGUAGE:** English (matching Phase 2 files).
**TONE:** Imperative, direct, factual. No conversational prose.
  </action>
  <verify>
1. File exists at `.claude/skills/astro-cloudflare/references/styling-performance.md`
2. File has between 250-320 lines
3. File starts with `# Styling and Performance`
4. Contains `## Quick Reference` with numbered rules
5. Contains image service selection matrix
6. Contains CSS approach selection matrix
7. Contains caching strategy table
8. Contains _headers file pattern
9. Contains Tailwind v4 setup code
10. Contains image component patterns code
11. Contains `## Anti-patterns` with CRITICAL/HIGH/MEDIUM tags
12. Contains `## Troubleshooting` with Symptom/Cause/Fix columns
13. Uses `@tailwindcss/vite` not `@astrojs/tailwind`
14. Uses `imageService: 'compile'` not Sharp
15. Does NOT contain hydration directives or Server Island patterns
  </verify>
  <done>
`styling-performance.md` exists with 250-320 lines, follows Phase 2 format, covers Tailwind v4 setup, image optimization without Sharp, caching strategies with _headers file, Core Web Vitals patterns, prefetch configuration. All Cloudflare-specific constraints documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify styling-performance.md quality and cross-references</name>
  <files>.claude/skills/astro-cloudflare/references/styling-performance.md</files>
  <action>
Read the completed file and verify:
1. Line count is 250-320
2. No Astro 4 deprecated patterns (`@astrojs/tailwind` as primary recommendation, `--astro-code-color-text`, `output: 'hybrid'`)
3. No content that belongs in other Phase 3 files (hydration directives, Server Islands, Content Layer, middleware, routing)
4. All code examples use Astro 5.x API correctly
5. Image service examples use `compile` or `cloudflare` (never Sharp for Workers)
6. Troubleshooting table has at least 3 Cloudflare-specific entries (Auto Minify, /_image 404, cache stale)
7. Quick Reference has 12-14 numbered rules in imperative tone
8. Anti-patterns table uses CRITICAL/HIGH/MEDIUM severity tags
9. `_headers` file pattern is complete and correct

If any issues found, fix them in place.
  </action>
  <verify>Run line count on the file to confirm range. Grep for deprecated patterns to confirm absence.</verify>
  <done>File passes all quality checks: correct line count, no deprecated patterns, no cross-domain content leakage, Cloudflare-specific troubleshooting entries present, correct image service recommendations.</done>
</task>

</tasks>

<verification>
- File follows Phase 2 format
- Tailwind v4 setup with @tailwindcss/vite (not deprecated integration)
- Image service correctly recommends compile/cloudflare (not Sharp)
- Caching strategy with _headers file pattern
- Both Astro-generic and Cloudflare-specific errors in troubleshooting
- ~280-300 lines, ~50% tables + ~50% code
</verification>

<success_criteria>
1. `styling-performance.md` covers Tailwind v4 migration from @astrojs/tailwind
2. Image optimization without Sharp documented with service selection matrix
3. Caching strategy with _headers file for Cloudflare
4. Core Web Vitals checklist (LCP priority, CLS prevention)
5. Prefetch strategy matrix
6. Troubleshooting table includes Cloudflare-specific errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-domain-references/03-04-SUMMARY.md`
</output>
