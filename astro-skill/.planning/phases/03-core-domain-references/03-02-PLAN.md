---
phase: 03-core-domain-references
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/routing-navigation.md
autonomous: true

must_haves:
  truths:
    - "Claude manually decodes route params with decodeURIComponent in Astro 5.x"
    - "Claude uses output:'static' with per-page prerender:false instead of removed output:'hybrid'"
    - "Claude uses ClientRouter (not deprecated ViewTransitions) for client-side navigation"
    - "Claude guards runtime.env access in middleware for prerendered routes"
    - "Claude excludes _server-islands/* from catch-all routes to prevent infinite loops"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/routing-navigation.md"
      provides: "Routing and Navigation reference"
      min_lines: 250
      contains: "Quick Reference"
  key_links:
    - from: "routing-navigation.md"
      to: "Phase 2 cloudflare-platform.md"
      via: "cross-reference for _routes.json and Workers limits"
      pattern: "cloudflare-platform"
---

<objective>
Write the `routing-navigation.md` reference file covering file-based routing, dynamic routes, ClientRouter, middleware basics, redirects/rewrites, and catch-all route pitfalls on Cloudflare.

Purpose: Claude needs to generate correct routing code for Astro 5.x on Cloudflare, including the breaking changes (param decoding, paginate base, hybrid removal) and Cloudflare-specific pitfalls (_routes.json limits, Server Islands loops).
Output: `references/routing-navigation.md` (~280-300 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-domain-references/03-RESEARCH.md
@.planning/phases/03-core-domain-references/03-CONTEXT.md

# Phase 2 reference files -- match format and style
@.claude/skills/astro-cloudflare/references/project-structure.md
@.claude/skills/astro-cloudflare/references/rendering-modes.md
@.claude/skills/astro-cloudflare/references/cloudflare-platform.md

# Primary research source
@docs/researchs/4 - Routing.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write routing-navigation.md reference file</name>
  <files>.claude/skills/astro-cloudflare/references/routing-navigation.md</files>
  <action>
Write `routing-navigation.md` following the exact format established by Phase 2 reference files. Target ~280-300 lines. Content ratio: ~50% tables + ~50% code examples, minimal narrative prose.

**STRUCTURE (in order):**

1. **Title + subtitle** (1 line): `# Routing and Navigation` + subtitle mentioning file-based routing, dynamic routes, ClientRouter, middleware, redirects on Cloudflare.

2. **Quick Reference** (~12 numbered imperative rules):
   Draw from Research 4 section 1. Must include:
   - Decode all params manually with `decodeURIComponent(Astro.params.slug)` -- auto-decode removed in Astro 5.0
   - Remove manual `base` concatenation in paginate() links -- `page.url.next` includes base since v5.0
   - Use `output: 'static'` (default) with per-page `prerender: false` -- `output: 'hybrid'` removed in v5.0
   - Use `<ClientRouter />` from `astro:transitions` -- `<ViewTransitions />` deprecated in 5.0, removed in 6.0
   - Limit `_routes.json` to 100 rules max with wildcards -- exceed causes deploy error 8000057
   - Never prerender `404.astro` when using Server Islands -- causes 404 on `/_server-islands/` requests
   - Exclude `/_server-islands/*` from catch-all `[...slug].astro` -- prevents infinite loop / Worker crash
   - Prefer `redirects` in astro.config.mjs over `_redirects` file -- `_redirects` ignored by Worker functions
   - Guard `runtime.env` access in middleware: `if (context.locals.runtime?.env)` -- undefined during prerendering
   - Avoid `trailingSlash: 'always'` with API endpoints -- causes routing conflicts on Cloudflare
   - Use `routes.extend.exclude` to force static serving of specific routes
   - Access env vars via `Astro.locals.runtime.env` in SSR -- never `process.env` or `import.meta.env` for secrets

3. **Routing Strategy Decision Matrix** (~10 rows table):
   Format: `| Page Type | Approach | Cloudflare Reasoning |`
   Draw from Research 4 section 2. Cover: static page, blog with 100+ posts, user dashboard, REST API endpoint, personalized content on static page (Server Islands), permanent redirect, internal rewrite, pagination with base path, catch-all endpoint, multi-param route.

4. **Route Priority Reference** (~8 lines):
   Numbered list showing Astro route priority order (from Research 4 section 6.1):
   1. Reserved routes (_astro/, _server_islands/, _actions/)
   2. Segment count (more segments win)
   3. Static routes over dynamic
   4. Named params over rest params
   5. Prerendered over on-demand
   6. Endpoints over pages
   7. File routes over config redirects
   8. Alphabetical fallback

5. **Middleware Pattern** (~20 lines code):
   Show `defineMiddleware` with:
   - Runtime env guard for prerendered routes
   - Setting `context.locals` properties
   - Using `sequence()` to chain multiple middleware
   Draw from Research 4 section 5.4 + official middleware docs.
   NOTE: Keep to basics (signature, sequence, locals, redirects). Auth/CSP middleware belongs in Phase 4.

6. **Catch-all Route Guard Pattern** (~15 lines code):
   Show `[...slug].astro` with exclusion of `_server-islands`, `_astro`, `_actions` routes.
   Include `decodeURIComponent` on the slug.
   Draw from Research 4 section 5.6.

7. **API Endpoint Pattern** (~15 lines code):
   Show REST endpoint on Cloudflare Workers with `locals.runtime.env` for D1/KV access.
   Include `ALL` method fallback for 405 response.
   Draw from Research 4 section 5.3.

8. **ClientRouter** (~10 lines):
   Brief section: import from `astro:transitions`, basic usage in Layout.
   Note: replaces deprecated `<ViewTransitions />`. Native View Transitions API is the long-term direction.
   Keep minimal -- just enough to prevent Claude from using the old name.

9. **Anti-patterns** table (~12 rows):
   Format: `| Don't | Do | Severity |`
   Must include:
   - CRITICAL: `output: 'hybrid'` -> use `'static'` or `'server'` (removed in v5.0)
   - CRITICAL: `process.env.SECRET` in SSR -> `Astro.locals.runtime.env.SECRET`
   - CRITICAL: `params.slug` without decode -> `decodeURIComponent(params.slug)`
   - HIGH: Manual `base` concat with `page.url.next` -> use directly (includes base since v5)
   - HIGH: `_redirects` file for Worker-handled routes -> `redirects` in astro.config.mjs
   - HIGH: 100+ individual rules in `_routes.json` -> use wildcards
   - HIGH: Catch-all without `_server-islands` exclusion -> guard check
   - HIGH: `prerender: true` on 404.astro with Server Islands -> set to `false`
   - HIGH: Async at module global scope in endpoint -> move inside handler function
   - MEDIUM: `trailingSlash: 'always'` with API endpoints -> use `'never'` or `'ignore'`
   - MEDIUM: `getStaticPaths()` on `prerender: false` page -> remove it, use `Astro.params`
   - MEDIUM: `import fs from 'fs'` in SSR endpoint -> use Web APIs or `node:` prefix

10. **Troubleshooting** table (~10 rows):
    Format: `| Symptom | Cause | Fix |`
    Must include Cloudflare-specific entries:
    - 404 in prod but works in dev -> `_routes.json` missing route -> add `routes.extend.include`
    - Params show `%20` instead of spaces -> v5.0 breaking change -> `decodeURIComponent()`
    - Pagination URLs doubled `/docs/docs/page/2` -> paginate() includes base -> remove manual concat
    - Error 1042/522 for custom 404 -> 404.astro prerendered with Server Islands -> set `prerender: false`
    - Server Islands infinite loop -> catch-all matches `/_server-islands/*` -> add guard
    - `runtime.env` undefined in dev -> platformProxy not enabled or `.dev.vars` missing
    - `runtime.env` undefined during build -> middleware accessing env for prerendered route -> add guard
    - Error 8000057 overlapping rules -> duplicate patterns in _routes.json -> use wildcards
    - Redirect not working on SSR route -> `_redirects` ignored by Functions -> use config or code
    - Cold start 500ms+ on first request -> Worker evicted after inactivity -> prefer prerender or warm-up

**CONTENT BOUNDARIES (from cross-domain assignment):**
- DO include: file-based routing, dynamic routes, getStaticPaths, ClientRouter, middleware basics, redirects, rewrites, catch-all patterns, route priority, API endpoints
- DO NOT include: middleware auth/CSP (belongs in Phase 4 security-advanced.md)
- DO NOT include: Server Islands implementation details (belongs in components-islands.md)
- DO NOT include: Content Layer/Actions (belongs in data-content.md)
- DO NOT include: hydration directives (belongs in components-islands.md)

**LANGUAGE:** English (matching Phase 2 files).
**TONE:** Imperative, direct, factual. No conversational prose.
  </action>
  <verify>
1. File exists at `.claude/skills/astro-cloudflare/references/routing-navigation.md`
2. File has between 250-320 lines
3. File starts with `# Routing and Navigation`
4. Contains `## Quick Reference` with numbered rules
5. Contains routing strategy decision matrix table
6. Contains at least 3 code blocks (middleware, catch-all, API endpoint)
7. Contains `## Anti-patterns` with CRITICAL/HIGH/MEDIUM tags
8. Contains `## Troubleshooting` with Symptom/Cause/Fix columns
9. Uses `<ClientRouter />` not `<ViewTransitions />`
10. Uses `output: 'static'` not `output: 'hybrid'`
11. Contains `decodeURIComponent` pattern
12. Contains middleware runtime.env guard
13. Does NOT contain auth/CSP middleware patterns
14. Does NOT contain hydration directives or Server Island implementation
  </verify>
  <done>
`routing-navigation.md` exists with 250-320 lines, follows Phase 2 format, covers routing with Astro 5.x breaking changes (param decoding, paginate base, hybrid removal), ClientRouter, middleware basics, catch-all guards, API endpoints. All Cloudflare-specific pitfalls documented. No content duplication with other Phase 3 files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify routing-navigation.md quality and cross-references</name>
  <files>.claude/skills/astro-cloudflare/references/routing-navigation.md</files>
  <action>
Read the completed file and verify:
1. Line count is 250-320
2. No Astro 4 deprecated patterns (`output: 'hybrid'`, `<ViewTransitions />`, `entry.slug`, `type: 'content'`)
3. No content that belongs in other Phase 3 files (hydration directives, image optimization, Content Layer, Tailwind, Server Island implementation)
4. No Phase 4 content (auth middleware, CSP headers, CSRF protection)
5. All code examples use Astro 5.x API correctly
6. Troubleshooting table has at least 3 Cloudflare-specific entries
7. Quick Reference has 10-12 numbered rules in imperative tone
8. Anti-patterns table uses CRITICAL/HIGH/MEDIUM severity tags

If any issues found, fix them in place.
  </action>
  <verify>Run line count on the file to confirm range. Grep for deprecated patterns to confirm absence.</verify>
  <done>File passes all quality checks: correct line count, no deprecated patterns, no cross-domain content leakage, Cloudflare-specific troubleshooting entries present, no Phase 4 content.</done>
</task>

</tasks>

<verification>
- File follows Phase 2 format
- Astro 5.x breaking changes prominently documented (decodeURIComponent, paginate base, hybrid removal)
- ClientRouter used (not ViewTransitions)
- Middleware covers basics only (no auth/CSP)
- Both Astro-generic and Cloudflare-specific errors in troubleshooting
- ~280-300 lines, ~50% tables + ~50% code
</verification>

<success_criteria>
1. `routing-navigation.md` covers all routing breaking changes from Astro 5.0
2. Middleware pattern includes runtime.env guard for Cloudflare
3. Catch-all route guard pattern excludes _server-islands/*
4. ClientRouter documented (not deprecated ViewTransitions)
5. Troubleshooting table includes Cloudflare-specific errors
6. No Phase 4 security content (auth, CSP, CSRF)
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-domain-references/03-02-SUMMARY.md`
</output>
