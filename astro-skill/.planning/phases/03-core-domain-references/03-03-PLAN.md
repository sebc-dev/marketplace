---
phase: 03-core-domain-references
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/data-content.md
autonomous: true

must_haves:
  truths:
    - "Claude uses loader:glob()/file() instead of deprecated type:'content'/type:'data'"
    - "Claude uses entry.id instead of removed entry.slug"
    - "Claude imports render from astro:content instead of calling entry.render()"
    - "Claude uses z from astro/zod instead of from zod package directly"
    - "Claude knows when to use Astro Actions vs API routes for form handling and mutations"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/data-content.md"
      provides: "Data and Content management reference"
      min_lines: 250
      contains: "Quick Reference"
  key_links:
    - from: "data-content.md"
      to: "Phase 2 project-structure.md"
      via: "cross-reference for content.config.ts location"
      pattern: "project-structure"
---

<objective>
Write the `data-content.md` reference file covering Content Layer API (glob/file loaders), Zod schemas, Astro Actions vs API routes, and MDX/Markdoc setup.

Purpose: Claude needs to generate correct content management code for Astro 5.x -- the Content Layer API has multiple breaking changes from v4, and the Actions vs API routes decision needs clear guidance for Cloudflare Workers.
Output: `references/data-content.md` (~280-300 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-domain-references/03-RESEARCH.md
@.planning/phases/03-core-domain-references/03-CONTEXT.md

# Phase 2 reference files -- match format and style
@.claude/skills/astro-cloudflare/references/project-structure.md
@.claude/skills/astro-cloudflare/references/rendering-modes.md

# Primary research sources
@docs/researchs/5 - Gestion des donn√©es.md
@docs/researchs/18 - Markdown MDX Markdoc.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write data-content.md reference file</name>
  <files>.claude/skills/astro-cloudflare/references/data-content.md</files>
  <action>
Write `data-content.md` following the exact format established by Phase 2 reference files. Target ~280-300 lines. Content ratio: ~50% tables + ~50% code examples, minimal narrative prose.

**STRUCTURE (in order):**

1. **Title + subtitle** (1 line): `# Data and Content` + subtitle mentioning Content Layer API, loaders, collections, Astro Actions, MDX/Markdoc on Cloudflare.

2. **Quick Reference** (~12 numbered imperative rules):
   Draw from Research 5 section 1 + Research 18 section 1. Must include:
   - Place config at `src/content.config.ts` -- not `src/content/config.ts` (first cause of migration errors)
   - Use `loader: glob({ pattern, base })` -- not `type: 'content'` (deprecated v5)
   - Use `entry.id` -- not `entry.slug` (removed in v5)
   - Import render separately: `import { render } from 'astro:content'` then `render(entry)` -- not `entry.render()`
   - Use `z` from `astro/zod` -- not from `zod` package (types incompatible)
   - Always `export const prerender = true` on content collection pages for Cloudflare -- Workers has no filesystem at runtime
   - Use `file()` loader for single JSON/YAML files -- supports custom `parser` option for CSV
   - Use inline async loader for external API data -- return array with `id` property on each item
   - Use `reference('collection')` for inter-collection relationships
   - Use `z.coerce.date()` for frontmatter dates -- converts ISO strings to Date objects
   - Run `npx astro sync` after schema changes to regenerate types
   - Filter drafts manually: `getCollection("posts", ({data}) => !data.draft)` -- no automatic filtering in v5

3. **Loader Selection Matrix** (~8 rows table):
   Format: `| Data Source | Loader | Reason |`
   Draw from Research 5 section 2a. Cover: local Markdown/MDX, single JSON/YAML, CSV with parser, external REST API, API with sync tokens, Storyblok CMS, RSS feeds, Airtable.

4. **Actions vs API Routes Matrix** (~8 rows table):
   Format: `| Use Case | Choice | Why |`
   Cover: form submission with validation, REST API for external consumers, type-safe mutation from client, webhook handler, file upload, server-to-server call, progressive enhancement form, CRUD endpoint.
   Actions = type-safe, form-aware, progressive enhancement. API routes = REST, external consumers, webhooks.

5. **Content Layer Config Example** (~25 lines code):
   Show `src/content.config.ts` with:
   - `glob()` loader for Markdown blog with schema using `image()`, `reference()`, `z.coerce.date()`
   - `file()` loader for JSON data
   - Export `collections` object
   Draw from Research 5 section 6 patterns.

6. **Astro Actions Basic Signature** (~20 lines code):
   Show `src/actions/index.ts` with:
   - `defineAction` with `accept: 'form'`, `input` with Zod schema, `handler` with context
   - Accessing `ctx.locals.runtime.env` for Cloudflare bindings in handler
   - Brief note on calling from client: `import { actions } from 'astro:actions'`
   NOTE: Keep to basic signature and decision matrix. CSRF/validation details belong in Phase 4.

7. **MDX/Markdoc Decision** (~15 lines table + brief):
   Table: `| Format | Use When | Key Difference |`
   Cover: plain .md (no imports needed), .mdx (JSX imports, interactive components), .mdoc (safe authoring, custom tags)
   Brief notes:
   - MDX inherits from `markdown.*` config -- do NOT duplicate plugins in `mdx()` options
   - Markdoc uses `markdoc.config.mjs` for custom tag definitions
   - Both process at build-time only -- fully compatible with Cloudflare Workers

8. **Rendering Content Pattern** (~15 lines code):
   Show blog post page with:
   - `getEntry()` / `getCollection()` usage
   - `render(entry)` returning `{ Content, headings, remarkPluginFrontmatter }`
   - Component mapping via `<Content components={{}} />`
   Draw from Research 18 section 5.

9. **Anti-patterns** table (~12 rows):
   Format: `| Don't | Do | Severity |`
   Must include:
   - CRITICAL: `type: 'content'` in defineCollection -> `loader: glob()` (deprecated v5)
   - CRITICAL: `entry.slug` -> `entry.id` (removed in v5)
   - CRITICAL: `entry.render()` -> `import { render } from 'astro:content'` (removed in v5)
   - CRITICAL: `import { z } from 'zod'` -> `import { z } from 'astro/zod'` (type mismatch)
   - HIGH: Reading filesystem in SSR on Cloudflare -> prerender with `prerender = true`
   - HIGH: fetch() SSR without timeout -> implement AbortController with 5-10s timeout
   - HIGH: `image().refine()` for dimension validation -> removed in v5, validate at runtime
   - HIGH: Duplicate remarkPlugins in markdown AND mdx config -> configure in `markdown.*` only
   - MEDIUM: `Astro.glob()` -> use `import.meta.glob()` (deprecated in v5)
   - MEDIUM: Schema too permissive (`z.any()`) -> type explicitly with `.default()` fallbacks
   - MEDIUM: Community loaders >1 year without update -> check for maintained fork
   - MEDIUM: `compiledContent()` called synchronously -> `await compiledContent()` (async since v5)

10. **Troubleshooting** table (~10 rows):
    Format: `| Symptom | Cause | Fix |`
    Must include Cloudflare-specific:
    - `Cannot find module 'astro:content'` -> config file wrong location -> move to `src/content.config.ts`
    - `entry.slug is undefined` -> v5 breaking change -> replace with `entry.id`
    - `entry.render is not a function` -> v5 API change -> import `render` from `astro:content`
    - Collection empty without error -> glob() base path invalid -> verify path relative to project root
    - `ENOENT` or file not found on SSR Cloudflare -> Workers has no filesystem -> add `prerender = true`
    - Frontmatter properties missing in entry.data -> v5 filters undeclared fields -> add to schema or use `z.passthrough()`
    - `reference()` fields break randomly in dev -> known bug #12680 -> comment field, restart dev, uncomment
    - Shiki theme unchanged after config change -> Content Collections cache -> delete `.astro/data-store.json`
    - Types `astro:content` disappear after save -> dev server bug -> restart dev server or run `astro sync`
    - fetch() timeout on SSR -> CPU time exceeded or no error handling -> AbortController + try/catch

**CONTENT BOUNDARIES (from cross-domain assignment):**
- DO include: Content Layer API, loaders, collections, schemas, Actions basics, MDX/Markdoc setup, rendering content
- DO NOT include: content.config.ts file placement details (brief cross-ref to project-structure.md)
- DO NOT include: Actions CSRF/validation (belongs in Phase 4 security-advanced.md)
- DO NOT include: middleware (belongs in routing-navigation.md)
- DO NOT include: image optimization (belongs in styling-performance.md)
- DO NOT include: hydration directives (belongs in components-islands.md)

**LANGUAGE:** English (matching Phase 2 files).
**TONE:** Imperative, direct, factual. No conversational prose.
  </action>
  <verify>
1. File exists at `.claude/skills/astro-cloudflare/references/data-content.md`
2. File has between 250-320 lines
3. File starts with `# Data and Content`
4. Contains `## Quick Reference` with numbered rules
5. Contains loader selection matrix table
6. Contains Actions vs API routes decision matrix
7. Contains content.config.ts code example with glob() and file()
8. Contains Actions defineAction code example
9. Contains `## Anti-patterns` with CRITICAL/HIGH/MEDIUM tags
10. Contains `## Troubleshooting` with Symptom/Cause/Fix columns
11. Uses `entry.id` not `entry.slug`
12. Uses `render(entry)` import pattern not `entry.render()`
13. Uses `loader: glob()` not `type: 'content'`
14. Uses `z from 'astro/zod'` not `z from 'zod'`
15. Does NOT contain CSRF/validation details for Actions
  </verify>
  <done>
`data-content.md` exists with 250-320 lines, follows Phase 2 format, covers Content Layer API with all v5 breaking changes (slug->id, render import, config location, loader migration), Actions basic signature and decision matrix, MDX/Markdoc decision. No Phase 4 security content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify data-content.md quality and cross-references</name>
  <files>.claude/skills/astro-cloudflare/references/data-content.md</files>
  <action>
Read the completed file and verify:
1. Line count is 250-320
2. No Astro 4 deprecated patterns (`type: 'content'`, `type: 'data'`, `entry.slug`, `entry.render()`, `import { z } from 'zod'`, `Astro.glob()`, `output: 'hybrid'`)
3. No content that belongs in other Phase 3 files (image optimization, hydration directives, middleware, Tailwind)
4. No Phase 4 content (CSRF protection, Actions validation details, auth middleware, CSP)
5. All code examples use Astro 5.x Content Layer API correctly
6. Troubleshooting table has at least 2 Cloudflare-specific entries (ENOENT on Workers, fetch timeout)
7. Quick Reference has 10-12 numbered rules in imperative tone
8. Anti-patterns table uses CRITICAL/HIGH/MEDIUM severity tags

If any issues found, fix them in place.
  </action>
  <verify>Run line count on the file to confirm range. Grep for deprecated patterns to confirm absence.</verify>
  <done>File passes all quality checks: correct line count, no deprecated patterns, no cross-domain content leakage, Cloudflare-specific troubleshooting entries present, no Phase 4 content.</done>
</task>

</tasks>

<verification>
- File follows Phase 2 format
- All Astro 5.x Content Layer breaking changes correctly documented
- Actions kept to basics (no CSRF/validation from Phase 4)
- MDX/Markdoc decision clearly laid out
- Both Astro-generic and Cloudflare-specific errors in troubleshooting
- ~280-300 lines, ~50% tables + ~50% code
</verification>

<success_criteria>
1. `data-content.md` covers all Content Layer v5 breaking changes (slug->id, render, config location, loaders)
2. Loader selection matrix helps choose between glob/file/inline/object loaders
3. Actions vs API routes decision matrix with clear scenarios
4. MDX/Markdoc decision guidance included
5. Troubleshooting table includes Cloudflare-specific errors
6. No Phase 4 security content (CSRF, validation details)
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-domain-references/03-03-SUMMARY.md`
</output>
