---
phase: 03-core-domain-references
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/references/components-islands.md
autonomous: true

must_haves:
  truths:
    - "Claude knows which hydration directive to use for any given component scenario"
    - "Claude correctly implements Server Islands with server:defer, fallback slots, and <2KB serializable props"
    - "Claude uses nanostores for cross-island state sharing instead of DOM manipulation or prop drilling"
    - "Claude avoids client:load by default and prefers client:visible or client:idle"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/references/components-islands.md"
      provides: "Components and Islands Architecture reference"
      min_lines: 250
      contains: "Quick Reference"
  key_links:
    - from: "components-islands.md"
      to: "Phase 2 rendering-modes.md"
      via: "cross-reference for Server Islands setup"
      pattern: "rendering-modes"
---

<objective>
Write the `components-islands.md` reference file covering Astro component patterns, hydration directives, Server Islands, and inter-island communication with nanostores.

Purpose: Claude needs feature-level knowledge for building interactive components on Astro/Cloudflare -- specifically which hydration strategy to choose, how Server Islands work with server:defer, and how to share state between isolated islands.
Output: `references/components-islands.md` (~280-300 lines)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-domain-references/03-RESEARCH.md
@.planning/phases/03-core-domain-references/03-CONTEXT.md

# Phase 2 reference files -- match format and style
@.claude/skills/astro-cloudflare/references/project-structure.md
@.claude/skills/astro-cloudflare/references/rendering-modes.md

# Primary research sources
@docs/researchs/3 - Composants.md
@docs/researchs/6 - Islands Architecture.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write components-islands.md reference file</name>
  <files>.claude/skills/astro-cloudflare/references/components-islands.md</files>
  <action>
Write `components-islands.md` following the exact format established by Phase 2 reference files (project-structure.md, rendering-modes.md). Target ~280-300 lines. Content ratio: ~50% tables + ~50% code examples, minimal narrative prose.

**STRUCTURE (in order):**

1. **Title + subtitle** (1 line): `# Components and Islands` + subtitle mentioning hydration directives, Server Islands, nanostores, component patterns on Cloudflare.

2. **Quick Reference** (~12 numbered imperative rules):
   Draw from Research 3 rules 4-15 and Research 6 Quick Reference. Must include:
   - Use `client:visible` as default for below-fold components -- saves initial JS
   - Use `client:idle` with timeout for above-fold non-critical -- `client:idle={{timeout: 500}}`
   - Reserve `client:load` only for critical immediate interactions (checkout, auth)
   - Use `client:visible={{rootMargin: "200px"}}` to pre-hydrate before viewport entry
   - Use `client:media="(max-width: 768px)"` for mobile-only components
   - Use `client:only="react"` when component needs browser APIs and SSR is not viable
   - Always provide `slot="fallback"` for Server Islands with matching dimensions to prevent CLS
   - Keep Server Island props < 2KB and serializable (no functions, no class instances) -- >2KB switches to POST (uncacheable)
   - Use `Astro.request.headers.get('Referer')` inside Server Islands -- `Astro.url` returns `/_server-islands/ComponentName`
   - Use nanostores for cross-island state -- import same store module path in all islands
   - Never write to nanostores from `.astro` frontmatter -- it does not affect client-side components
   - Always destructure `class` before spread: `const { class: className, ...rest } = Astro.props` -- pass `{...rest}` to include `data-astro-cid-*`

3. **Hydration Directive Decision Matrix** (~10 rows table):
   Format: `| Scenario | Directive | Why |`
   Draw from Research 6 section 2. Scenarios: checkout button, burger menu, below-fold carousel, chat widget, mobile sidebar, client-only component (maps), footer contact form, analytics tracking, search modal, comment section.

4. **Island vs Static vs Server Island Matrix** (~8 rows table):
   Format: `| Need | Approach | Why Not Alternatives |`
   Draw from Research 6 section 4. Cover: static nav, dropdown menu, dynamic price, add-to-cart button, user avatar, product filter list, editorial content, real-time widget.

5. **Nanostores Pattern** (~30 lines code):
   Show a complete nanostores example with:
   - Store definition (atom + map) in `src/stores/cart.ts`
   - Usage in a framework component (React or Vue) with `useStore`
   - Usage in .astro page showing the store import for read-only data passing
   - Note about `.get()` in handlers vs `useStore()` for rendering
   Draw from Research 6 section 7 patterns.

6. **Server Island Pattern** (~25 lines code):
   Show the full server:defer pattern:
   - Page with `server:defer` and `slot="fallback"` with fixed dimensions
   - Server Island component accessing `Astro.request.headers` and `Astro.cookies`
   - Cache-Control header on the Server Island response
   Draw from Research 3 Pattern 6 and Research 6 section 5.

7. **Component Typing Patterns** (~20 lines code):
   Show two patterns:
   - HTMLAttributes extension: `interface Props extends HTMLAttributes<"a"> { external?: boolean; }`
   - Polymorphic component: `type Props<Tag extends HTMLTag> = Polymorphic<{ as: Tag }> & { variant?: "primary" | "secondary"; }`
   Draw from Research 3 Patterns 1 and 5.

8. **Anti-patterns** table (~12 rows):
   Format: `| Don't | Do | Severity |`
   Confidence tags: CRITICAL, HIGH, MEDIUM.
   Must include:
   - CRITICAL: `client:load` on all components -> use `client:visible`/`client:idle`
   - CRITICAL: Functions as Server Island props -> pass IDs, fetch inside island
   - HIGH: Nesting islands (island inside island) -> single island with child components
   - HIGH: Server Island in named slot -> use as direct child (bug #13969)
   - HIGH: `Astro.url` inside Server Island -> use Referer header
   - HIGH: Writing nanostores from .astro frontmatter -> initialize client-side only
   - HIGH: DOM manipulation between islands -> nanostores or CustomEvent
   - MEDIUM: `client:only` without fallback -> always provide fallback HTML
   - MEDIUM: Mapping `client:load` over arrays -> one controller island for N static items
   - MEDIUM: 3+ framework runtimes in one project -> one primary + vanilla JS
   - MEDIUM: Complex nested props to islands -> flatten, pass IDs
   - MEDIUM: CSS child selector `> .child` with islands -> account for `<astro-island>` wrapper

9. **Troubleshooting** table (~10 rows):
   Format: `| Symptom | Cause | Fix |`
   Must include both Astro-generic AND Cloudflare-specific:
   - Hydration completed but contains mismatches -> Auto Minify Cloudflare -> disable in dashboard
   - Island never hydrates -> missing `client:*` directive or wrong import path
   - `client:visible` never triggers -> element has `display:none` or zero dimensions -> use `client:idle`
   - Nanostores not syncing between islands -> different import paths (alias vs relative) -> unify paths
   - Server Islands return 404 -> `src/pages/404.astro` with `prerender = true` -> set to `false`
   - Server Islands broken in production CF -> Auto Minify removes HTML comments -> disable
   - Scoped styles not applied -> `{...rest}` not passed -> spread rest props on root element
   - Props undefined in component -> missing `interface Props` definition
   - Server Island returns wrong URL -> normal: `Astro.url` = `/_server-islands/Name` -> use Referer header
   - `Cannot bundle node:stream` (Vue SSR CF) -> add to `vite.ssr.external`, enable `nodejs_compat`

**CONTENT BOUNDARIES (from cross-domain assignment):**
- DO include: hydration directives, Server Islands, nanostores, component props/slots/typing
- DO NOT include: image optimization (belongs in styling-performance.md)
- DO NOT include: ClientRouter/View Transitions (belongs in routing-navigation.md)
- DO NOT include: middleware (belongs in routing-navigation.md)
- DO NOT include: Content Layer/Actions (belongs in data-content.md)
- DO NOT include: Tailwind setup (belongs in styling-performance.md)

**LANGUAGE:** English (matching Phase 2 files).
**TONE:** Imperative, direct, factual. No conversational prose.
  </action>
  <verify>
1. File exists at `.claude/skills/astro-cloudflare/references/components-islands.md`
2. File has between 250-320 lines
3. File starts with `# Components and Islands`
4. File contains `## Quick Reference` section with numbered rules
5. Contains at least 2 decision matrix tables
6. Contains at least 3 code blocks
7. Contains `## Anti-patterns` table with CRITICAL/HIGH/MEDIUM tags
8. Contains `## Troubleshooting` table with Symptom/Cause/Fix columns
9. No mention of `output: 'hybrid'` (removed in Astro 5)
10. No mention of `entry.slug` (replaced by `entry.id`)
11. No mention of `<ViewTransitions />` (renamed to `<ClientRouter />`)
12. Contains `server:defer` pattern with `slot="fallback"`
13. Contains nanostores pattern (atom, map, useStore)
14. Does NOT contain image optimization content
15. Does NOT contain middleware content
  </verify>
  <done>
`components-islands.md` exists with 250-320 lines, follows Phase 2 format (Quick Reference, decision matrices, code patterns, anti-patterns with severity tags, troubleshooting table), covers hydration directives, Server Islands, nanostores, and component typing patterns. All Astro 5.x APIs used correctly. No content duplication with other Phase 3 files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify components-islands.md quality and cross-references</name>
  <files>.claude/skills/astro-cloudflare/references/components-islands.md</files>
  <action>
Read the completed file and verify:
1. Line count is 250-320
2. No Astro 4 deprecated patterns (`output: 'hybrid'`, `entry.slug`, `entry.render()`, `<ViewTransitions />`, `type: 'content'`)
3. No content that belongs in other Phase 3 files (image optimization, middleware, ClientRouter, Content Layer, Tailwind)
4. All code examples use Astro 5.x API correctly
5. Troubleshooting table has at least 2 Cloudflare-specific entries (Auto Minify, nodejs_compat)
6. Quick Reference has 10-12 numbered rules in imperative tone
7. Anti-patterns table uses CRITICAL/HIGH/MEDIUM severity tags

If any issues found, fix them in place.
  </action>
  <verify>Run line count on the file to confirm range. Grep for deprecated patterns to confirm absence.</verify>
  <done>File passes all quality checks: correct line count, no deprecated patterns, no cross-domain content leakage, Cloudflare-specific troubleshooting entries present.</done>
</task>

</tasks>

<verification>
- File follows Phase 2 format (Quick Reference, tables, code, anti-patterns, troubleshooting)
- Content boundaries respected per cross-domain assignment table
- All code examples use Astro 5.x API (no Astro 4 patterns)
- Both Astro-generic and Cloudflare-specific errors in troubleshooting
- ~280-300 lines, ~50% tables + ~50% code
</verification>

<success_criteria>
1. `components-islands.md` covers hydration directives with decision tree format
2. Server Islands pattern with server:defer, fallback, props constraints documented
3. Nanostores cross-island communication pattern complete
4. Anti-patterns tagged CRITICAL/HIGH/MEDIUM
5. Troubleshooting table includes Cloudflare-specific errors
6. No content duplication with other Phase 3 reference files
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-domain-references/03-01-SUMMARY.md`
</output>
