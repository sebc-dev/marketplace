---
phase: 09-skill-three-way-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/astro-cloudflare/SKILL.md
autonomous: true

must_haves:
  truths:
    - "SKILL.md MCP Integration section contains a routing table mapping 8 domains to three sources (Astro MCP, Cloudflare MCP, skill references)"
    - "Cloudflare MCP tool entry exists with tool name, scope (Workers/KV/D1/R2), 2 query templates, and caveats"
    - "Existing Astro MCP content is preserved verbatim (bullet points unchanged)"
    - "Existing 'Use THIS SKILL' block is preserved verbatim"
    - "SKILL.md body stays under 280 lines (target: 268 max)"
  artifacts:
    - path: ".claude/skills/astro-cloudflare/SKILL.md"
      provides: "Dual-MCP routing guidance in MCP Integration section"
      contains: "search_cloudflare_documentation"
  key_links:
    - from: "SKILL.md routing table"
      to: "MCP tool entries"
      via: "Source column references (Astro MCP, Cloudflare MCP, Skill references)"
      pattern: "Astro MCP|Cloudflare MCP|Skill references"
---

<objective>
Expand the MCP Integration section of SKILL.md with dual-MCP coordination: a three-way routing table, a Cloudflare MCP tool entry mirroring the Astro MCP entry, query templates, caveats, and fallback guidance. All within a +30 line budget.

Purpose: Satisfies requirements MCP-01 through MCP-05 -- Claude now knows which source to use for any Astro-on-Cloudflare question.
Output: Updated SKILL.md with expanded MCP Integration section (~46 lines, up from 18).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-skill-three-way-routing/09-CONTEXT.md
@.planning/phases/09-skill-three-way-routing/09-RESEARCH.md
@.planning/phases/08-mcp-tool-verification/08-VERIFICATION.md
@.claude/skills/astro-cloudflare/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace MCP Integration section with dual-MCP routing content</name>
  <files>.claude/skills/astro-cloudflare/SKILL.md</files>
  <action>
Replace lines 82-99 of SKILL.md (the entire MCP Integration section, from `## MCP Integration` up to but NOT including `## Reference Navigation` on line 100) with the following expanded content. Use Edit tool to do an exact string replacement.

**The new MCP Integration section must contain these elements in this exact order:**

1. **Section heading:** `## MCP Integration` (unchanged)

2. **Routing sub-section** (`### Source Routing`):
   - Markdown table with columns: Domain | Source | Example
   - 8 rows covering: (a) Astro components/routing/config -> Astro MCP, (b) Astro Actions/Content Layer -> Astro MCP, (c) Workers runtime/limits/compat -> Cloudflare MCP, (d) KV binding API -> Cloudflare MCP, (e) D1 binding API -> Cloudflare MCP, (f) R2 binding API -> Cloudflare MCP, (g) Astro-on-Cloudflare patterns -> Skill references, (h) Troubleshooting/anti-patterns -> Skill references
   - After table: blockquote note with excluded CF products (Zaraz, Magic Transit, Zero Trust, CDN, DNS, AI) and fallback rule (primary source first, ambiguous defaults to skill references)
   - Keep example questions SHORT (6-8 words max, technical shorthand)

3. **Astro MCP sub-section** (`### Astro Docs MCP`):
   - `**Tool:** \`mcp__astro_doc__search_astro_docs\``
   - The existing "Use MCP when you need:" list -- COPY VERBATIM from current lines 86-91. Do NOT change any bullet point text.

4. **Cloudflare MCP sub-section** (`### Cloudflare Docs MCP`):
   - `**Tool:** \`mcp__cloudflare__search_cloudflare_documentation\``
   - Scope line: `**Scope:** Workers, KV, D1, R2 only. Query pattern: \`"[Product] [specific action]"\``
   - 2 query template examples as bullet points:
     - `"Workers KV namespace put method API parameters"`
     - `"Cloudflare D1 database prepare bind SQL API"`
   - Caveats as blockquote: mention empty titles (extract from `<text>` heading) and doubled URL prefixes (strip first `https://developers.cloudflare.com/` prefix)

5. **Use THIS SKILL block** (existing, VERBATIM):
   - `**Use THIS SKILL when you need:**` followed by the 5 existing bullet points from current lines 93-98. COPY EXACTLY, no changes.

**Critical constraints:**
- Do NOT touch anything before line 82 (Critical Rules, Decision Matrices) or after line 99 (Reference Navigation onwards)
- The new section replaces lines 82-99 inclusive (the blank line 99 before `## Reference Navigation`)
- Preserve a single blank line before `## Reference Navigation` starts
- Total new section should be approximately 46 lines (delta of +28 from current 18)

**Reference the exact content from 09-RESEARCH.md Examples 1-3 for draft wording.** Use 2 query template examples (not 3) to stay within budget.
  </action>
  <verify>
Run these checks:
1. `grep -n "search_cloudflare_documentation" .claude/skills/astro-cloudflare/SKILL.md` -- must return at least one match
2. `grep -n "### Source Routing" .claude/skills/astro-cloudflare/SKILL.md` -- must return one match
3. `grep -n "### Astro Docs MCP" .claude/skills/astro-cloudflare/SKILL.md` -- must return one match
4. `grep -n "### Cloudflare Docs MCP" .claude/skills/astro-cloudflare/SKILL.md` -- must return one match
5. `grep -c "defineAction" .claude/skills/astro-cloudflare/SKILL.md` -- should return 2 (one in routing table, one in Astro MCP bullets)
6. `grep -n "## Reference Navigation" .claude/skills/astro-cloudflare/SKILL.md` -- must still exist, now at a higher line number
7. Count body lines (after YAML frontmatter): `tail -n +19 .claude/skills/astro-cloudflare/SKILL.md | wc -l` -- must be under 280
  </verify>
  <done>
SKILL.md MCP Integration section contains: (a) routing table with 8 domain rows, (b) Astro MCP entry with unchanged bullet points, (c) Cloudflare MCP entry with tool name + scope + 2 query templates + caveats, (d) unchanged "Use THIS SKILL" block. Body line count is under 280.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify content integrity and requirement coverage</name>
  <files>.claude/skills/astro-cloudflare/SKILL.md</files>
  <action>
After Task 1 completes, run a comprehensive verification pass:

**Line budget verification:**
- Count SKILL.md body lines (everything after YAML frontmatter line 18): must be under 280, target under 268
- If over 268 but under 280: note it but do not change (within hard limit)
- If over 280: trim query template examples from 2 to 1, or merge blockquote notes

**Content integrity verification:**
- Run `git diff .claude/skills/astro-cloudflare/SKILL.md` and verify:
  - Lines 1-81 (before MCP Integration) show ZERO changes
  - Lines after `## Reference Navigation` show ZERO changes (just line number shifts)
  - The 5 "Use MCP when you need:" bullet points are byte-identical to the original
  - The 5 "Use THIS SKILL when you need:" bullet points are byte-identical to the original

**Requirement coverage check:**
- MCP-01: `search_cloudflare_documentation` tool name is present with usage instructions -- grep for it
- MCP-02: Routing table exists with three sources (Astro MCP, Cloudflare MCP, Skill references) -- visual inspection
- MCP-03: Allowlist (Workers, KV, D1, R2) and exclusions (Zaraz, etc.) are documented -- grep for "Zaraz"
- MCP-04: Dual-MCP coordination instructions exist (routing table + fallback rule) -- grep for "Fallback"
- MCP-05: Query templates with scoped patterns exist -- grep for "Workers KV"

If any check fails, fix the issue in SKILL.md and re-verify. Do NOT create additional files.
  </action>
  <verify>
1. `tail -n +19 .claude/skills/astro-cloudflare/SKILL.md | wc -l` -- under 280 (target under 268)
2. `git diff .claude/skills/astro-cloudflare/SKILL.md | head -100` -- only MCP Integration section changed
3. `grep -c "Astro MCP\|Cloudflare MCP\|Skill references" .claude/skills/astro-cloudflare/SKILL.md` -- at least 6 matches (routing table rows)
4. `grep "Zaraz" .claude/skills/astro-cloudflare/SKILL.md` -- exclusion note present
5. `grep "Workers KV" .claude/skills/astro-cloudflare/SKILL.md` -- query template present
  </verify>
  <done>
All 5 requirements (MCP-01 through MCP-05) are covered. Line budget is within limits. No v0.1 content modified outside MCP Integration section. Git diff confirms surgical edit.
  </done>
</task>

</tasks>

<verification>
**Phase 9 success criteria (from ROADMAP.md):**
1. SKILL.md contains `search_cloudflare_documentation` tool entry with usage instructions -> check via grep
2. Three-way routing table maps question domains to sources -> check routing table has 3 distinct Source values
3. Cloudflare product allowlist and exclusions are documented -> check for "Workers, KV, D1, R2" and "Zaraz"
4. Query templates for scoped searches are provided -> check for template examples
5. SKILL.md body stays under 280 lines -> check line count
</verification>

<success_criteria>
- `grep "search_cloudflare_documentation" SKILL.md` returns a match
- `grep "### Source Routing" SKILL.md` returns a match
- Routing table contains 8 rows with 3 distinct source types
- Body line count < 280
- `git diff` shows changes ONLY in the MCP Integration section (lines 82-99 replaced, everything else untouched)
</success_criteria>

<output>
After completion, create `.planning/phases/09-skill-three-way-routing/09-01-SUMMARY.md`
</output>
